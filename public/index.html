<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>GiftBot</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}
:root{
  --bg:#0a0a0a;--glass:rgba(28,30,32,0.9);--gb:rgba(255,255,255,0.07);
  --green:#2ecc71;--green2:#27ae60;--gdim:rgba(46,204,113,0.12);--gbor:rgba(46,204,113,0.25);
  --red:#ff6060;--rdim:rgba(255,96,96,0.12);--orange:#f39c12;
  --text:#f0f0f0;--muted:#555;--muted2:#777;--nav:#111213;
}
html,body{background:var(--bg);color:var(--text);font-family:-apple-system,'SF Pro Display','Helvetica Neue',sans-serif;height:100%;overflow:hidden;overscroll-behavior:none}
.app{display:flex;flex-direction:column;height:100vh;height:100dvh}
.pages{flex:1;overflow:hidden;position:relative}
.page{display:none;position:absolute;inset:0;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:16px 14px calc(70px + env(safe-area-inset-bottom));overscroll-behavior-y:contain}
.page::-webkit-scrollbar{display:none}
.page.active{display:block;animation:pIn .26s ease forwards}
.page.exit{display:block;animation:pOut .18s ease forwards;pointer-events:none}
@keyframes pIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes pOut{from{opacity:1}to{opacity:0}}

/* NAV */
.nav{flex-shrink:0;display:flex;align-items:center;background:var(--nav);border-top:1px solid rgba(255,255,255,.05);padding:0 4px;padding-bottom:env(safe-area-inset-bottom);height:calc(52px + env(safe-area-inset-bottom))}
.nb{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;cursor:pointer;color:var(--muted);font-size:9px;font-weight:500;border:none;background:none;font-family:inherit;padding:5px 2px;position:relative;transition:color .2s}
.nb svg{width:19px;height:19px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round}
.nb.active{color:var(--green)}
.nb.active::before{content:'';position:absolute;inset:2px 4px;border-radius:8px;background:var(--gdim)}
.nb>*{position:relative;z-index:1}

/* GLASS */
.gc{background:var(--glass);backdrop-filter:blur(16px) saturate(130%);-webkit-backdrop-filter:blur(16px) saturate(130%);border:1px solid var(--gb);border-radius:16px;position:relative;overflow:hidden}
.gc::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.03) 0%,transparent 60%);pointer-events:none;z-index:0}

/* SHARED */
.phdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.ptitle{font-size:22px;font-weight:800;letter-spacing:-.4px}
.bpill{display:flex;align-items:center;gap:5px;background:var(--gdim);border:1px solid var(--gbor);border-radius:20px;padding:6px 11px;font-size:14px;font-weight:700;color:var(--green);flex-shrink:0}
.bpill svg{width:14px;height:14px;stroke:var(--green);fill:none;stroke-width:2;stroke-linecap:round;flex-shrink:0}
.sec{font-size:15px;font-weight:700;margin-bottom:10px}

/* TOAST */
.toast{position:fixed;top:14px;left:50%;transform:translateX(-50%) translateY(-70px);padding:8px 14px;border-radius:14px;font-size:12px;font-weight:600;z-index:9999;transition:transform .3s cubic-bezier(.34,1.4,.64,1);white-space:nowrap;pointer-events:none;max-width:80vw;text-align:center}
.toast.show{transform:translateX(-50%) translateY(0)}
.toast.g{background:#1a2e1a;border:1px solid rgba(46,204,113,.35);color:var(--green)}
.toast.r{background:#2e1a1a;border:1px solid rgba(255,96,96,.35);color:var(--red)}

/* HOME */
.hhdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.huser{display:flex;align-items:center;gap:10px}
.av-wrap{position:relative;flex-shrink:0}
.av{width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,#2ecc71,#1a7a40);display:flex;align-items:center;justify-content:center;font-size:19px;font-weight:700;overflow:hidden;border:2px solid rgba(46,204,113,.4)}
.av img{width:100%;height:100%;object-fit:cover}
/* Crown */
.av-crown{position:absolute;top:-10px;left:50%;transform:translateX(-50%);display:none;z-index:5}
.av-crown svg{width:24px;height:24px}
.av-crown.show{display:block}
/* Legend glow */
.av-wrap.legend-glow .av{box-shadow:0 0 0 3px var(--legend-color,#2ecc71),0 0 20px var(--legend-color,#2ecc71),0 0 40px var(--legend-color,rgba(46,204,113,.4))}
.welcome{font-size:11px;color:var(--muted2);margin-bottom:2px}

/* Nick color classes */
.nc-default span{background:linear-gradient(135deg,#fff 0%,#2ecc71 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.nc-purple span{background:linear-gradient(135deg,#bf5af2 0%,#e040fb 50%,#da8fff 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.nc-gold span{background:linear-gradient(135deg,#f4c430 0%,#ffab00 50%,#f39c12 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.nc-red span{background:linear-gradient(135deg,#ff6060 0%,#ff2d2d 50%,#ff4444 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.nc-blue span{background:linear-gradient(135deg,#5b8def 0%,#4a7adc 50%,#3a5bbe 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.nc-pink span{background:linear-gradient(135deg,#ff6fb7 0%,#ff4daa 50%,#ff2299 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.nc-cyan span{background:linear-gradient(135deg,#00e5ff 0%,#00b4d8 50%,#0077b6 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}

.uname{font-size:19px;font-weight:800;display:flex;align-items:center}

/* GRID */
.mgrid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
.mc{background:var(--glass);backdrop-filter:blur(16px) saturate(130%);-webkit-backdrop-filter:blur(16px) saturate(130%);border:1px solid var(--gb);border-radius:16px;padding:18px 10px 14px;display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer;transition:transform .12s,opacity .12s;position:relative;overflow:hidden}
.mc::after{content:'';position:absolute;inset:0;background:linear-gradient(155deg,rgba(255,255,255,.03),transparent 55%);pointer-events:none}
.mc:active{transform:scale(.95);opacity:.85}
.mc-ico{width:42px;height:42px;border-radius:13px;background:var(--gdim);border:1px solid var(--gbor);display:flex;align-items:center;justify-content:center;position:relative;z-index:1}
.mc-ico svg{width:22px;height:22px;stroke:var(--green);fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round}
.mc-t{font-size:13px;font-weight:700;position:relative;z-index:1;text-align:center}
.mc-s{font-size:10px;color:var(--muted2);text-align:center;position:relative;z-index:1}

/* PROMO */
.pcrd{padding:12px;margin-bottom:10px}
.plbl{display:flex;align-items:center;gap:6px;font-size:12px;font-weight:600;color:var(--green);margin-bottom:8px}
.prow2{display:flex;gap:7px}
.pin{flex:1;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px 12px;color:var(--muted2);font-size:13px;outline:none;font-family:inherit;transition:border-color .2s,color .2s;min-width:0}
.pin:focus{border-color:var(--green);color:var(--text)}
.pbtn{background:var(--green);color:#000;border:none;border-radius:10px;padding:10px 14px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;white-space:nowrap;transition:transform .1s;flex-shrink:0}
.pbtn:active{transform:scale(.95)}

/* TASKS */
.ti{padding:12px 13px;display:flex;align-items:center;gap:11px;margin-bottom:7px;cursor:pointer;transition:transform .1s,opacity .1s}
.ti:active{transform:scale(.97);opacity:.8}
.tico{width:40px;height:40px;border-radius:11px;background:var(--gdim);border:1px solid var(--gbor);display:flex;align-items:center;justify-content:center;font-size:19px;flex-shrink:0;position:relative;z-index:1}
.tinf{flex:1;min-width:0;position:relative;z-index:1}
.ttag{display:inline-block;border-radius:5px;padding:1px 6px;font-size:9px;font-weight:700;margin-bottom:2px;letter-spacing:.3px}
.ttag.r{background:var(--rdim);color:var(--red)}
.ttag.g{background:var(--gdim);color:var(--green)}
.tname{font-size:13px;font-weight:600;margin-bottom:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tdesc{font-size:10px;color:var(--muted2)}
.trew{color:var(--green);font-weight:700;font-size:11px;white-space:nowrap;flex-shrink:0;position:relative;z-index:1}
.tdone{background:var(--gdim);color:var(--green);border-radius:7px;padding:3px 8px;font-size:11px;font-weight:700;flex-shrink:0;position:relative;z-index:1}

/* SHOP */
.stabs{display:flex;gap:5px;margin-bottom:12px;background:rgba(0,0,0,.3);border-radius:11px;padding:3px}
.stab{flex:1;padding:8px;border-radius:8px;border:none;background:transparent;color:var(--muted);font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .2s}
.stab.active{background:var(--glass);color:var(--text)}
.sgrid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.sitem{padding:13px 9px 11px;text-align:center;cursor:pointer;transition:transform .1s}
.sitem:active{transform:scale(.96)}
.sico{font-size:30px;margin-bottom:6px}
.sname{font-size:11px;font-weight:600;margin-bottom:4px}
.sprice{color:var(--green);font-weight:700;font-size:11px;margin-bottom:7px}
.sbuy{width:100%;background:var(--green);color:#000;border:none;border-radius:8px;padding:7px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit;transition:opacity .1s;position:relative;z-index:1}
.sbuy:active{opacity:.8}
.sbuy:disabled,.sbuy.wip{background:rgba(255,255,255,.06);color:var(--muted2);cursor:default}
.sbuy.nomoney{background:var(--rdim);color:var(--red)}

/* CASES */
.cgrid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.ccard{cursor:pointer;transition:transform .12s;overflow:hidden;border-radius:15px;border:1px solid var(--gb)}
.ccard:active{transform:scale(.96)}
.ccimg{height:96px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.ccimg-ico{width:50px;height:50px;border-radius:15px;display:flex;align-items:center;justify-content:center;position:relative;z-index:1}
.ccimg-ico svg{width:26px;height:26px;fill:none;stroke-width:1.6;stroke-linecap:round;stroke-linejoin:round}
.ccimg::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 50% 30%,rgba(255,255,255,.06),transparent 70%)}
.ccinfo{padding:7px 9px 9px;background:var(--glass)}
.ccname{font-size:12px;font-weight:700;margin-bottom:2px}
.ccprice{color:var(--green);font-weight:700;font-size:10px;display:flex;align-items:center;gap:3px;margin-bottom:5px}
.ccprice svg{width:10px;height:10px;stroke:var(--green);fill:none;stroke-width:2}
.ccpvbtn{width:100%;background:rgba(255,255,255,.05);border:none;border-radius:6px;padding:4px;font-size:9px;color:var(--muted2);cursor:pointer;font-family:inherit;position:relative;z-index:1;transition:background .15s}
.ccpvbtn:active{background:rgba(255,255,255,.1)}

/* INVENTORY */
.inv-grid{display:flex;flex-direction:column;gap:8px}
.inv-item{padding:12px 14px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:transform .1s,opacity .1s}
.inv-item:active{transform:scale(.97);opacity:.8}
.inv-ico{font-size:26px;flex-shrink:0;width:42px;height:42px;background:var(--gdim);border:1px solid var(--gbor);border-radius:11px;display:flex;align-items:center;justify-content:center;position:relative;z-index:1}
.inv-info{flex:1;min-width:0;position:relative;z-index:1}
.inv-name{font-size:13px;font-weight:700;margin-bottom:2px}
.inv-desc{font-size:10px;color:var(--muted2)}
.inv-cnt{font-size:18px;font-weight:900;color:var(--green);flex-shrink:0;position:relative;z-index:1}
.inv-empty{display:flex;flex-direction:column;align-items:center;padding:50px 20px;gap:12px;opacity:.4}
.inv-empty-ico{font-size:44px}
.inv-empty-t{font-size:15px;font-weight:700}
.inv-empty-s{font-size:12px;color:var(--muted);text-align:center}

/* RAFFLES */
.raff-empty{display:flex;flex-direction:column;align-items:center;padding:60px 20px 40px;gap:14px}
.raff-empty-ico{font-size:52px;opacity:.22}
.raff-empty-t{font-size:18px;font-weight:800;color:#3a3a3a}
.raff-empty-s{font-size:12px;color:var(--muted);text-align:center;line-height:1.5}

/* FRIENDS */
.refblock{background:rgba(46,204,113,.08);border:1px solid rgba(46,204,113,.2);border-radius:15px;padding:14px;margin-bottom:12px;position:relative;overflow:hidden}
.refblock::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(46,204,113,.4),transparent)}
.reflbl{font-size:9px;font-weight:700;color:var(--green);letter-spacing:1px;text-transform:uppercase;margin-bottom:5px}
.refamt{font-size:24px;font-weight:900;color:var(--green);margin-bottom:10px;display:flex;align-items:center;gap:6px}
.refamt svg{width:18px;height:18px;stroke:var(--green);fill:none;stroke-width:2}
.refwarn{background:var(--rdim);border:1px solid rgba(255,96,96,.2);border-radius:10px;padding:8px 11px;margin-bottom:10px;font-size:11px;color:var(--red);line-height:1.5}
.reflinkrow{background:rgba(0,0,0,.3);border:1px solid rgba(46,204,113,.2);border-radius:10px;padding:9px 11px;margin-bottom:8px;display:flex;align-items:center;gap:7px}
.reflinkt{flex:1;font-size:11px;color:var(--green);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-family:monospace}
.refcopy{width:32px;height:32px;background:var(--gdim);border:none;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}
.refcopy svg{width:13px;height:13px;stroke:var(--green);fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
.refshare{width:100%;background:var(--green);color:#000;border:none;border-radius:12px;padding:12px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;transition:opacity .15s}
.refshare:active{opacity:.8}
.refstats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px;margin-bottom:12px}
.rstat{padding:10px 5px;text-align:center;position:relative;overflow:hidden}
.rslbl{font-size:8px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;font-weight:600;margin-bottom:6px;line-height:1.4}
.rsval{font-size:20px;font-weight:900;position:relative;z-index:1}
.rsval.g{font-size:16px;color:var(--green);display:flex;align-items:center;justify-content:center;gap:3px}
.rsval.g svg{width:12px;height:12px;stroke:var(--green);fill:none;stroke-width:2}
.rssub{font-size:8px;color:var(--muted);margin-top:2px;position:relative;z-index:1}
.rtask{padding:12px 13px;margin-bottom:12px}
.rtop{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}
.rtag2{background:var(--rdim);color:var(--red);border-radius:20px;padding:2px 8px;font-size:10px;font-weight:600}
.rprize{color:var(--green);font-weight:700;font-size:12px;display:flex;align-items:center;gap:3px}
.rprize svg{width:12px;height:12px;stroke:var(--green);fill:none;stroke-width:2}
.rtitle2{font-size:14px;font-weight:700;margin-bottom:4px}
.rdesc2{font-size:11px;color:var(--muted2);line-height:1.5;margin-bottom:8px}
.rpb{background:rgba(255,255,255,.07);border-radius:3px;height:3px;margin-bottom:4px}
.rpbf{background:var(--green);border-radius:3px;height:100%;transition:width .5s}
.norefs{display:flex;flex-direction:column;align-items:center;padding:28px 20px;gap:10px;opacity:.4}
.nrico{font-size:40px}
.nrt{font-size:15px;font-weight:700}

/* PROFILE */
.profuc{padding:13px;margin-bottom:8px;display:flex;align-items:center;gap:12px}
.profav-wrap{position:relative;flex-shrink:0}
.profav{width:58px;height:58px;border-radius:50%;background:linear-gradient(135deg,var(--green),#1a7a40);display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:700;border:2px solid rgba(46,204,113,.4);overflow:hidden}
.profav img{width:100%;height:100%;object-fit:cover}
.profav-crown{position:absolute;top:-10px;left:50%;transform:translateX(-50%);display:none}
.profav-crown svg{width:22px;height:22px}
.profav-crown.show{display:block}
.profname{font-size:18px;font-weight:800;margin-bottom:2px;background:linear-gradient(135deg,#fff,#2ecc71);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.profun{font-size:12px;color:var(--muted2)}
.prow{padding:12px 13px;margin-bottom:7px;display:flex;align-items:center;gap:12px;position:relative}
.prow-c{cursor:pointer;transition:transform .1s}
.prow-c:active{transform:scale(.97)}
.pro-ico{width:24px;text-align:center;color:var(--green);flex-shrink:0;position:relative;z-index:1}
.pro-ico svg{width:19px;height:19px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round}
.pro-c2{flex:1;position:relative;z-index:1}
.pro-l{font-size:10px;color:var(--muted2);margin-bottom:2px}
.pro-v{font-size:14px;font-weight:600}
.pro-arr{color:var(--muted);font-size:17px;position:relative;z-index:1}
.pro-info{width:24px;height:24px;border-radius:50%;background:var(--gdim);display:flex;align-items:center;justify-content:center;cursor:pointer;border:none;position:relative;z-index:1}
.pro-info svg{width:11px;height:11px;stroke:var(--green);fill:none;stroke-width:2;stroke-linecap:round}
.profpromo{padding:13px}
.profplbl{display:flex;align-items:center;gap:6px;font-size:12px;font-weight:600;color:var(--green);margin-bottom:8px}
.vip-active{color:var(--green);font-weight:700}
.vip-expired{color:var(--orange);font-weight:700}
.vip-none{color:var(--red);font-weight:700}

/* MODALS */
.modal-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.82);backdrop-filter:blur(8px);z-index:500;align-items:flex-end}
.modal-ov.show{display:flex}
.modal-box{background:#161819;border-radius:22px 22px 0 0;width:100%;padding:0 0 calc(20px + env(safe-area-inset-bottom));border-top:1px solid rgba(255,255,255,.08);animation:shup .24s cubic-bezier(.4,0,.2,1);max-height:88vh;overflow-y:auto}
.modal-box::-webkit-scrollbar{display:none}
@keyframes shup{from{transform:translateY(100%)}to{transform:translateY(0)}}
.mh{width:34px;height:4px;background:rgba(255,255,255,.1);border-radius:4px;margin:11px auto 0}
.mt{font-size:16px;font-weight:800;padding:14px 16px 4px}
.ms{font-size:12px;color:var(--muted2);padding:0 16px 14px;line-height:1.5}
.mbtn{width:calc(100% - 28px);margin:0 14px 8px;border:none;border-radius:12px;padding:13px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;transition:opacity .15s}
.mbtn:active{opacity:.8}
.mbtn.g{background:var(--green);color:#000}
.mbtn.gray{background:rgba(255,255,255,.06);color:var(--muted2)}
.mbtn.r{background:var(--rdim);color:var(--red)}

/* CASE MODAL */
.cmo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);backdrop-filter:blur(8px);z-index:700;flex-direction:column;align-items:center;justify-content:center;padding:14px}
.cmo.show{display:flex}
.cmbox{background:#161819;border-radius:20px;width:100%;max-width:420px;overflow:hidden;border:1px solid rgba(255,255,255,.08);animation:cin .3s cubic-bezier(.34,1.4,.64,1)}
@keyframes cin{from{transform:scale(.84);opacity:0}to{transform:scale(1);opacity:1}}
.cmhdr{display:flex;align-items:center;justify-content:space-between;padding:14px 14px 10px;border-bottom:1px solid rgba(255,255,255,.06)}
.cmtitle{font-size:16px;font-weight:800}
.cmclose{width:28px;height:28px;border-radius:50%;background:rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;color:var(--muted2);border:none;font-family:inherit}
.rw{position:relative;overflow:hidden;height:104px;background:#0d0e0f}
.rw::before,.rw::after{content:'';position:absolute;top:0;bottom:0;width:55px;z-index:2;pointer-events:none}
.rw::before{left:0;background:linear-gradient(90deg,#0d0e0f,transparent)}
.rw::after{right:0;background:linear-gradient(-90deg,#0d0e0f,transparent)}
.rtrack{display:flex;gap:5px;padding:5px;will-change:transform}
.ritem{min-width:84px;height:94px;border-radius:10px;flex-shrink:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;background:#1a1c1e;border:1.5px solid rgba(255,255,255,.06)}
.ritem.win{border-color:var(--green)!important;background:#0d2218!important;box-shadow:0 0 14px rgba(46,204,113,.2)}
.rico{font-size:26px}
.rname{font-size:8px;color:var(--muted2);font-weight:600;text-align:center;padding:0 3px}
.rval{font-size:9px;color:var(--green);font-weight:700}
.rcline{position:absolute;top:0;bottom:0;left:50%;width:2px;background:var(--green);transform:translateX(-50%);box-shadow:0 0 10px var(--green);pointer-events:none;z-index:3}
.rca-t{position:absolute;top:0;left:50%;transform:translateX(-50%);z-index:4;border-left:6px solid transparent;border-right:6px solid transparent;border-top:8px solid var(--green);pointer-events:none}
.rca-b{position:absolute;bottom:0;left:50%;transform:translateX(-50%);z-index:4;border-left:6px solid transparent;border-right:6px solid transparent;border-bottom:8px solid var(--green);pointer-events:none}
.cmfoot{padding:12px 14px}
.cmcost{text-align:center;font-size:11px;color:var(--muted2);margin-bottom:8px}
.cmspin{width:100%;background:var(--green);color:#000;border:none;border-radius:12px;padding:13px;font-size:14px;font-weight:800;cursor:pointer;font-family:inherit;transition:opacity .15s}
.cmspin:active{opacity:.8}
.cmspin:disabled{background:rgba(255,255,255,.06);color:var(--muted);cursor:not-allowed}
.cres{display:none;padding:22px 18px;text-align:center}
.cres.show{display:block}
.cres-ico{font-size:58px;display:block;margin-bottom:10px;animation:bounce .5s ease}
@keyframes bounce{0%,100%{transform:scale(1)}50%{transform:scale(1.14)}}
.cres-t{font-size:18px;font-weight:800;margin-bottom:4px}
.cres-s{font-size:12px;color:var(--muted2);margin-bottom:16px}
.cres-btn{width:100%;background:var(--green);color:#000;border:none;border-radius:12px;padding:12px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit}

/* PRIZES PREVIEW */
.pvmo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.82);backdrop-filter:blur(6px);z-index:600;align-items:flex-end}
.pvmo.show{display:flex}
.pvbox{background:#161819;border-radius:22px 22px 0 0;width:100%;padding:0 0 calc(16px + env(safe-area-inset-bottom));border-top:1px solid rgba(255,255,255,.08);animation:shup .24s cubic-bezier(.4,0,.2,1)}
.pvhdr{display:flex;align-items:center;justify-content:space-between;padding:14px 14px 10px}
.pvtitle{font-size:15px;font-weight:800}
.pvclose{width:26px;height:26px;border-radius:50%;background:rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:13px;color:var(--muted2);border:none}
.pvgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:7px;padding:0 12px 12px}
.pvitem{background:rgba(255,255,255,.04);border-radius:9px;padding:9px 5px;text-align:center}
.pvico{font-size:20px;margin-bottom:3px}
.pvname{font-size:8px;color:var(--muted2);font-weight:600}
.pvval{font-size:9px;color:var(--green);font-weight:700;margin-top:1px}

/* COLOR PICKER */
.cpmo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.82);backdrop-filter:blur(6px);z-index:600;align-items:flex-end}
.cpmo.show{display:flex}
.cpbox{background:#161819;border-radius:22px 22px 0 0;width:100%;padding:0 0 calc(16px + env(safe-area-inset-bottom));border-top:1px solid rgba(255,255,255,.08);animation:shup .24s cubic-bezier(.4,0,.2,1)}
.cphdr{display:flex;align-items:center;justify-content:space-between;padding:14px 14px 10px}
.cptitle{font-size:15px;font-weight:800}
.cpclose{width:26px;height:26px;border-radius:50%;background:rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:13px;color:var(--muted2);border:none}
.cpgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;padding:0 12px 10px}
.cpitem{border:2px solid transparent;border-radius:11px;padding:11px 6px;text-align:center;cursor:pointer;font-size:12px;font-weight:700;transition:all .15s}
.cpitem:active{transform:scale(.96)}
.cpitem.sel{border-color:rgba(255,255,255,.4)!important}
.cpbuy{width:calc(100% - 24px);margin:0 12px 0;background:var(--green);color:#000;border:none;border-radius:12px;padding:12px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;transition:opacity .15s}
.cpbuy:active{opacity:.8}

/* LEGEND COLOR PICKER */
.lgmo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.82);backdrop-filter:blur(6px);z-index:600;align-items:flex-end}
.lgmo.show{display:flex}
.lgbox{background:#161819;border-radius:22px 22px 0 0;width:100%;padding:0 0 calc(16px + env(safe-area-inset-bottom));border-top:1px solid rgba(255,255,255,.08);animation:shup .24s cubic-bezier(.4,0,.2,1)}
.lghdr{display:flex;align-items:center;justify-content:space-between;padding:14px 14px 10px}
.lgcolors{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:0 12px 10px}
.lgcitem{height:44px;border-radius:10px;border:2px solid transparent;cursor:pointer;transition:all .15s}
.lgcitem:active{transform:scale(.96)}
.lgcitem.sel{border-color:rgba(255,255,255,.5)}
.lgbuy{width:calc(100% - 24px);margin:0 12px;background:var(--green);color:#000;border:none;border-radius:12px;padding:12px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;transition:opacity .15s}
.lgbuy:active{opacity:.8}
</style>
</head>
<body>
<div class="toast g" id="toast"></div>

<!-- PRIZES PREVIEW -->
<div class="pvmo" id="pvmo" onclick="if(event.target===this)this.classList.remove('show')">
  <div class="pvbox">
    <div class="pvhdr"><div class="pvtitle" id="pv-t">–ü—Ä–∏–∑—ã</div><button class="pvclose" onclick="document.getElementById('pvmo').classList.remove('show')">‚úï</button></div>
    <div class="pvgrid" id="pv-grid"></div>
  </div>
</div>

<!-- COLOR PICKER -->
<div class="cpmo" id="cpmo" onclick="if(event.target===this)this.classList.remove('show')">
  <div class="cpbox">
    <div class="cphdr"><div class="cptitle">üåà –¶–≤–µ—Ç –Ω–∏–∫–∞</div><button class="cpclose" onclick="document.getElementById('cpmo').classList.remove('show')">‚úï</button></div>
    <div class="cpgrid" id="cp-grid"></div>
    <button class="cpbuy" id="cp-btn" onclick="buyColor()">–ö—É–ø–∏—Ç—å ‚Äî 250 ü™ô</button>
  </div>
</div>

<!-- LEGEND GLOW PICKER -->
<div class="lgmo" id="lgmo" onclick="if(event.target===this)this.classList.remove('show')">
  <div class="lgbox">
    <div class="lghdr"><div style="font-size:15px;font-weight:800">‚ú® –¶–≤–µ—Ç —Å–≤–µ—á–µ–Ω–∏—è</div><button class="cpclose" onclick="document.getElementById('lgmo').classList.remove('show')">‚úï</button></div>
    <div style="font-size:12px;color:var(--muted2);padding:0 14px 10px">–í—ã–±–µ—Ä–∏ —Ü–≤–µ—Ç –∞—É—Ä—ã –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–π –õ–µ–≥–µ–Ω–¥—É</div>
    <div class="lgcolors" id="lg-colors"></div>
    <button class="lgbuy" onclick="activateLegend()" style="margin-bottom:0">‚ú® –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
  </div>
</div>

<!-- GENERAL MODAL -->
<div class="modal-ov" id="genmo" onclick="if(event.target===this)closeGenMo()">
  <div class="modal-box">
    <div class="mh"></div>
    <div class="mt" id="gm-t"></div>
    <div class="ms" id="gm-s"></div>
    <div id="gm-extra"></div>
    <button class="mbtn g" id="gm-a" onclick="doGenMo()"></button>
    <button class="mbtn gray" onclick="closeGenMo()">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<!-- CASE MODAL -->
<div class="cmo" id="cmo">
  <div class="cmbox">
    <div class="cmhdr"><div class="cmtitle" id="cm-t">–ö–µ–π—Å</div><button class="cmclose" onclick="closeCase()">‚úï</button></div>
    <div id="cm-spin">
      <div class="rw"><div class="rtrack" id="rtrack"></div><div class="rcline"></div><div class="rca-t"></div><div class="rca-b"></div></div>
      <div class="cmfoot"><div class="cmcost" id="cm-cost"></div><button class="cmspin" id="cm-btn" onclick="spinCase()">üé∞ –û—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å</button></div>
    </div>
    <div class="cres" id="cres">
      <span class="cres-ico" id="cr-ico">üéÅ</span>
      <div class="cres-t" id="cr-t">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</div>
      <div class="cres-s" id="cr-s"></div>
      <button class="cres-btn" onclick="closeCase()">–ó–∞–±—Ä–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- MEGA GIFT MODAL -->
<div class="cmo" id="megamo">
  <div class="cmbox">
    <div class="cmhdr"><div class="cmtitle">üéÅ –ú–µ–≥–∞-–ø–æ–¥–∞—Ä–æ–∫</div><button class="cmclose" onclick="document.getElementById('megamo').classList.remove('show')">‚úï</button></div>
    <div id="mega-spin">
      <div class="rw"><div class="rtrack" id="mega-rtrack"></div><div class="rcline"></div><div class="rca-t"></div><div class="rca-b"></div></div>
      <div class="cmfoot"><button class="cmspin" id="mega-btn" onclick="spinMega()">üé∞ –ö—Ä—É—Ç–∏—Ç—å</button></div>
    </div>
    <div class="cres" id="mega-res">
      <span class="cres-ico" id="mr-ico">üéÅ</span>
      <div class="cres-t" id="mr-t">–í—ã –ø–æ–ª—É—á–∏–ª–∏!</div>
      <div class="cres-s" id="mr-s"></div>
      <button class="cres-btn" onclick="document.getElementById('megamo').classList.remove('show')">–ó–∞–±—Ä–∞—Ç—å</button>
    </div>
  </div>
</div>

<div class="app">
<div class="pages">

<!-- HOME -->
<div class="page active" id="page-home">
  <div class="hhdr">
    <div class="huser">
      <div class="av-wrap" id="av-wrap-h">
        <div class="av" id="av-h">?</div>
        <div class="av-crown" id="crown-h"><svg viewBox="0 0 24 24" fill="#f4c430" stroke="#d4a017" stroke-width="1"><path d="M2 19h20l-3-10-4 5-3-8-3 8-4-5z"/><rect x="2" y="19" width="20" height="2" rx="1" fill="#f4c430"/></svg></div>
      </div>
      <div>
        <div class="welcome">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å,</div>
        <div class="uname nc-default" id="h-name-wrap"><span id="h-name">User</span></div>
      </div>
    </div>
    <div class="bpill"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg><span id="b-home">0</span></div>
  </div>
  <div class="mgrid">
    <div class="mc" onclick="go('tasks')">
      <div class="mc-ico"><svg viewBox="0 0 24 24"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg></div>
      <div class="mc-t">–ó–∞–¥–∞–Ω–∏—è</div><div class="mc-s">–í—ã–ø–æ–ª–Ω—è–π –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π</div>
    </div>
    <div class="mc" onclick="go('shop')">
      <div class="mc-ico"><svg viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 001.98 1.61h9.72a2 2 0 001.98-1.61L23 6H6"/></svg></div>
      <div class="mc-t">–ú–∞–≥–∞–∑–∏–Ω</div><div class="mc-s">–¢—Ä–∞—Ç—å –º–æ–Ω–µ—Ç—ã</div>
    </div>
    <div class="mc" onclick="go('raffles')">
      <div class="mc-ico"><svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/><line x1="12" y1="12" x2="12" y2="16"/><line x1="10" y1="14" x2="14" y2="14"/></svg></div>
      <div class="mc-t">–†–æ–∑—ã–≥—Ä—ã—à–∏</div><div class="mc-s">–ò—Å–ø—ã—Ç–∞–π —É–¥–∞—á—É</div>
    </div>
    <div class="mc" onclick="go('friends')">
      <div class="mc-ico"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg></div>
      <div class="mc-t">–†–µ—Ñ–µ—Ä–∞–ª—ã</div><div class="mc-s">–ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π</div>
    </div>
    <div class="mc" onclick="go('inventory')" style="grid-column:span 2">
      <div class="mc-ico"><svg viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg></div>
      <div class="mc-t">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div><div class="mc-s">–¢–≤–æ–∏ –ø—Ä–µ–¥–º–µ—Ç—ã –∏ –±–æ–Ω—É—Å—ã</div>
    </div>
  </div>
  <div class="gc pcrd">
    <div class="plbl"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>–ü—Ä–æ–º–æ–∫–æ–¥</div>
    <div class="prow2"><input class="pin" id="pi-h" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" autocapitalize="characters"><button class="pbtn" onclick="usePromo('pi-h')">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button></div>
  </div>
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
    <div class="sec" style="margin-bottom:0">–†–æ–∑—ã–≥—Ä—ã—à–∏</div>
    <button style="background:var(--gdim);color:var(--green);border:none;border-radius:8px;padding:4px 10px;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit" onclick="go('raffles')">–í—Å–µ</button>
  </div>
  <div class="raff-empty" style="padding:24px 10px 10px">
    <div class="raff-empty-ico">üéÅ</div>
    <div style="font-size:13px;color:var(--muted)">–ü–æ–∫–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –Ω–µ—Ç</div>
  </div>
</div>

<!-- TASKS -->
<div class="page" id="page-tasks">
  <div class="phdr"><div class="ptitle">–ó–∞–¥–∞–Ω–∏—è</div><div class="bpill"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg><span id="b-tasks">0</span></div></div>
  <div id="tasks-list"></div>
</div>

<!-- SHOP -->
<div class="page" id="page-shop">
  <div class="phdr"><div class="ptitle">–ú–∞–≥–∞–∑–∏–Ω</div><div class="bpill"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg><span id="b-shop">0</span></div></div>
  <div class="stabs">
    <button class="stab active" onclick="shopTab('items',this)">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
    <button class="stab" onclick="shopTab('cases',this)">üì¶ –ö–µ–π—Å—ã</button>
  </div>
  <div class="sgrid" id="shop-items"></div>
  <div class="cgrid" id="shop-cases" style="display:none"></div>
</div>

<!-- INVENTORY -->
<div class="page" id="page-inventory">
  <div class="phdr"><div class="ptitle">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div><div class="bpill"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg><span id="b-inv">0</span></div></div>
  <div class="inv-grid" id="inv-list"></div>
</div>

<!-- RAFFLES -->
<div class="page" id="page-raffles">
  <div class="phdr"><div class="ptitle">–†–æ–∑—ã–≥—Ä—ã—à–∏</div><div class="bpill"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg><span id="b-raffles">0</span></div></div>
  <div class="raff-empty"><div class="raff-empty-ico">üéÅ</div><div class="raff-empty-t">–ü–æ–∫–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –Ω–µ—Ç</div><div class="raff-empty-s">–°–∫–æ—Ä–æ –∑–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –ø—Ä–∏–∑—ã ‚Äî<br>—Å–ª–µ–¥–∏ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏!</div></div>
</div>

<!-- FRIENDS -->
<div class="page" id="page-friends">
  <div class="phdr"><div class="ptitle">–†–µ—Ñ–µ—Ä–∞–ª—ã</div><div class="bpill"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg><span id="b-friends">0</span></div></div>
  <div class="refblock">
    <div class="reflbl">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞</div>
    <div style="font-size:12px;color:var(--muted2);margin-bottom:4px">–ó–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ</div>
    <div class="refamt"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>1 000</div>
    <div class="refwarn">‚ö†Ô∏è –£ —Ä–µ—Ñ–µ—Ä–∞–ª–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å @username –≤ Telegram, –∏–Ω–∞—á–µ –Ω–µ –∑–∞—Å—á–∏—Ç–∞–µ—Ç—Å—è.</div>
    <div class="reflinkrow"><div class="reflinkt" id="ref-link">https://t.me/SATapp_bot?start=ref_...</div><button class="refcopy" onclick="copyRef()"><svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg></button></div>
    <button class="refshare" onclick="shareRef()">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –≤ Telegram</button>
  </div>
  <div class="refstats">
    <div class="rstat gc"><div class="rslbl">–õ–∏—á–Ω–æ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–µ</div><div class="rsval" id="ref-c1">0</div><div class="rssub">+1000 –∑–∞ –∫–∞–∂–¥–æ–≥–æ</div></div>
    <div class="rstat gc"><div class="rslbl">2-–π —É—Ä–æ–≤–µ–Ω—å</div><div class="rsval" id="ref-c2">0</div><div class="rssub">–°–∫–æ—Ä–æ</div></div>
    <div class="rstat gc"><div class="rslbl">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div><div class="rsval g" id="ref-e"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>0</div></div>
  </div>
  <div class="rtask gc">
    <div class="rtop"><div class="rtag2">–ó–∞–¥–∞–Ω–∏–µ</div><div class="rprize"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>2 000</div></div>
    <div class="rtitle2">–ü—Ä–∏–≥–ª–∞—Å–∏ 3 –¥—Ä—É–∑–µ–π</div>
    <div class="rdesc2">+1000 –∑–∞ –∫–∞–∂–¥–æ–≥–æ + –±–æ–Ω—É—Å 2000 –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ!</div>
    <div class="rpb"><div class="rpbf" id="ref-pb"></div></div>
    <div style="text-align:right;font-size:10px;color:var(--muted)" id="ref-pt">0 / 3</div>
  </div>
  <div class="sec">–í–∞—à–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—ã</div>
  <div id="ref-list"></div>
</div>

<!-- PROFILE -->
<div class="page" id="page-profile">
  <div class="phdr"><div class="ptitle">–ü—Ä–æ—Ñ–∏–ª—å</div><div class="bpill"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg><span id="b-profile">0</span></div></div>
  <div class="gc profuc">
    <div class="profav-wrap" id="av-wrap-p">
      <div class="profav" id="av-p">?</div>
      <div class="profav-crown" id="crown-p"><svg viewBox="0 0 24 24" fill="#f4c430" stroke="#d4a017" stroke-width="1"><path d="M2 19h20l-3-10-4 5-3-8-3 8-4-5z"/><rect x="2" y="19" width="20" height="2" rx="1" fill="#f4c430"/></svg></div>
    </div>
    <div><div class="profname" id="p-name">User</div><div class="profun" id="p-un">@username</div></div>
  </div>
  <div class="gc prow">
    <div class="pro-ico"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg></div>
    <div class="pro-c2"><div class="pro-l">–ë–∞–ª–∞–Ω—Å</div><div class="pro-v" id="p-bal">0</div></div>
    <button class="pro-info" onclick="toast('üí° –ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π –≤—ã–ø–æ–ª–Ω—è—è –∑–∞–¥–∞–Ω–∏—è!','g')"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg></button>
  </div>
  <div class="gc prow prow-c" onclick="go('friends')">
    <div class="pro-ico"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg></div>
    <div class="pro-c2"><div class="pro-l">–†–µ—Ñ–µ—Ä–∞–ª–æ–≤</div><div class="pro-v" id="p-refs">0</div></div>
    <span class="pro-arr">‚Ä∫</span>
  </div>
  <div class="gc prow">
    <div class="pro-ico"><svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></div>
    <div class="pro-c2"><div class="pro-l">VIP —Å—Ç–∞—Ç—É—Å</div><div class="pro-v" id="p-vip">‚Äî</div></div>
  </div>
  <div class="gc prow">
    <div class="pro-ico"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg></div>
    <div class="pro-c2"><div class="pro-l">–¶–≤–µ—Ç –Ω–∏–∫–∞</div><div class="pro-v" id="p-color">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π</div></div>
  </div>
  <div class="gc prow">
    <div class="pro-ico"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div>
    <div class="pro-c2"><div class="pro-l">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</div><div class="pro-v" id="p-reg">‚Äî</div></div>
  </div>
  <div class="gc profpromo">
    <div class="profplbl"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>–ü—Ä–æ–º–æ–∫–æ–¥</div>
    <div class="prow2"><input class="pin" id="pi-p" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" autocapitalize="characters"><button class="pbtn" onclick="usePromo('pi-p')">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button></div>
  </div>
</div>

</div><!-- /pages -->

<nav class="nav">
  <button class="nb active" id="nb-home" onclick="go('home')"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><span>–ì–ª–∞–≤–Ω–∞—è</span></button>
  <button class="nb" id="nb-tasks" onclick="go('tasks')"><svg viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg><span>–ó–∞–¥–∞–Ω–∏—è</span></button>
  <button class="nb" id="nb-shop" onclick="go('shop')"><svg viewBox="0 0 24 24"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg><span>–ú–∞–≥–∞–∑–∏–Ω</span></button>
  <button class="nb" id="nb-inventory" onclick="go('inventory')"><svg viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg><span>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</span></button>
  <button class="nb" id="nb-profile" onclick="go('profile')"><svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg><span>–ü—Ä–æ—Ñ–∏–ª—å</span></button>
</nav>
</div>

<script>
/* ‚ïê‚ïê TELEGRAM ‚ïê‚ïê */
const tg=window.Telegram?.WebApp;
if(tg){tg.ready();tg.expand();try{tg.setHeaderColor('#0a0a0a');tg.setBackgroundColor('#0a0a0a');}catch(e){}}
const TGU=tg?.initDataUnsafe?.user||{id:123456,first_name:'ik',username:'assate',photo_url:null};
const UID=String(TGU.id);

/* ‚ïê‚ïê STORAGE ‚ïê‚ïê */
const SK='gb4_'+UID;
function load(){try{const d=JSON.parse(localStorage.getItem(SK)||'{}');return d.v===5?d:null;}catch{return null;}}
function save(){try{localStorage.setItem(SK,JSON.stringify({v:5,balance:S.balance,doneTasks:[...S.doneTasks],usedPromos:[...S.usedPromos],regDate:S.regDate,refs:S.refs,refEarned:S.refEarned,refBy:S.refBy,vipExpiry:S.vipExpiry,nickColor:S.nickColor,hasCrown:S.hasCrown,legendExpiry:S.legendExpiry,legendColor:S.legendColor,inventory:S.inventory,bonusMulti:S.bonusMulti,vipDiscount:S.vipDiscount,task3refsDone:S.task3refsDone}));}catch{}}

const sv=load();
const today=new Date().toLocaleDateString('ru-RU',{day:'numeric',month:'long',year:'numeric'});

const S={
  balance:sv?.balance??1000,
  doneTasks:new Set(sv?.doneTasks||[]),
  usedPromos:new Set(sv?.usedPromos||[]),
  regDate:sv?.regDate||today,
  refs:sv?.refs||[],
  refEarned:sv?.refEarned||0,
  refBy:sv?.refBy||null,
  vipExpiry:sv?.vipExpiry||null,
  nickColor:sv?.nickColor||'',
  hasCrown:sv?.hasCrown||false,
  legendExpiry:sv?.legendExpiry||null,
  legendColor:sv?.legendColor||'#2ecc71',
  inventory:sv?.inventory||{},  // {key: count}
  bonusMulti:sv?.bonusMulti||0, // 0=none, 3=x3, 5=x5
  vipDiscount:sv?.vipDiscount||false,
  task3refsDone:sv?.task3refsDone||false,
};

/* ‚ïê‚ïê REF PARAM ‚ïê‚ïê */
(function(){
  try{
    const sp=tg?.initDataUnsafe?.start_param||'';
    if(!sp.startsWith('ref_'))return;
    const rUID=sp.replace('ref_','');
    if(rUID===UID||S.refBy)return;
    S.refBy=rUID;
    const rk='gb4_'+rUID;
    const rd=JSON.parse(localStorage.getItem(rk)||'{}');
    if(!rd.refs)rd.refs=[];
    rd.refs.push({name:TGU.username?'@'+TGU.username:TGU.first_name,date:today});
    rd.balance=(rd.balance||1000)+1000;
    rd.refEarned=(rd.refEarned||0)+1000;
    if(rd.refs.length>=3&&!rd.task3refsDone){rd.balance+=2000;rd.task3refsDone=true;}
    rd.v=5;
    localStorage.setItem(rk,JSON.stringify(rd));
    save();
  }catch{}
})();

/* ‚ïê‚ïê INVENTORY DEFS ‚ïê‚ïê */
const INV_DEF={
  gift:{ico:'üéÅ',name:'–ü–æ–¥–∞—Ä–æ–∫',desc:'–û—Ç–∫—Ä–æ–π –∏ –ø–æ–ª—É—á–∏ –æ—Ç 100 –¥–æ 500 –º–æ–Ω–µ—Ç',action:'openGift'},
  crystal:{ico:'üíé',name:'–ö—Ä–∏—Å—Ç–∞–ª–ª',desc:'–ù–∞–∫–æ–ø–∏ 10 –∏ –ø–æ–ª—É—á–∏ —Å–∫–∏–¥–∫—É 50% –Ω–∞ VIP 7 –¥–Ω–µ–π',action:'usecrystal'},
  bonus3:{ico:'‚ö°',name:'–ë–æ–Ω—É—Å —Ö3',desc:'–°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω–µ–∂–Ω—ã–π –ø—Ä–∏–∑ –∏–∑ –∫–µ–π—Å–∞ —É–º–Ω–æ–∂–∞–µ—Ç—Å—è –Ω–∞ 3 (1 —Ä–∞–∑)',action:'activateBonus3'},
  bonus5:{ico:'üî•',name:'–ë–æ–Ω—É—Å —Ö5',desc:'–°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω–µ–∂–Ω—ã–π –ø—Ä–∏–∑ –∏–∑ –∫–µ–π—Å–∞ —É–º–Ω–æ–∂–∞–µ—Ç—Å—è –Ω–∞ 5 (1 —Ä–∞–∑)',action:'activateBonus5'},
  ticket:{ico:'üéüÔ∏è',name:'–ë–∏–ª–µ—Ç',desc:'–ò—Å–ø–æ–ª—å–∑—É–π –¥–ª—è —É—á–∞—Å—Ç–∏—è –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–∞—Ö —Ç—Ä–µ–±—É—é—â–∏—Ö –±–∏–ª–µ—Ç—ã',action:'useTicket'},
  super:{ico:'üåü',name:'–°—É–ø–µ—Ä',desc:'–°–º–µ–Ω–∏ —Ü–≤–µ—Ç –Ω–∏–∫–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ (1 —Ä–∞–∑)',action:'useSuper'},
  crown:{ico:'üëë',name:'–ö–æ—Ä–æ–Ω–∞',desc:'–ù–∞–¥–µ–Ω—å –∫–æ—Ä–æ–Ω—É –Ω–∞ –∞–≤–∞—Ç–∞—Ä–∫—É ‚Äî –Ω–∞–≤—Å–µ–≥–¥–∞',action:'wearCrown'},
  legend:{ico:'‚ú®',name:'–õ–µ–≥–µ–Ω–¥–∞',desc:'–°–≤–µ—á–µ–Ω–∏–µ –≤–æ–∫—Ä—É–≥ –∞–≤–∞—Ç–∞—Ä–∫–∏ –Ω–∞ 14 –¥–Ω–µ–π ‚Äî –≤—ã–±–µ—Ä–∏ —Ü–≤–µ—Ç',action:'activateLegendItem'},
  megagift:{ico:'üéÅ',name:'–ú–µ–≥–∞-–ø–æ–¥–∞—Ä–æ–∫',desc:'–ö—Ä—É—Ç–∏ –º–µ–≥–∞-—Ä—É–ª–µ—Ç–∫—É: VIP 7–¥, –ë–∏–ª–µ—Ç—ã —Ö10, –ö–æ—Ä–æ–Ω–∞, –ö–µ–π—Å –ó–æ–ª–æ—Ç–æ–π',action:'openMegaGift'},
};

/* ‚ïê‚ïê CASES ‚ïê‚ïê */
const CASES=[
  {id:1,name:'–°—Ç–∞—Ä—Ç–æ–≤—ã–π',price:50,bg:'linear-gradient(145deg,#0d1f14,#122010)',ic:'#2ecc71',ib:'rgba(46,204,113,.15)',
   icon:`<svg viewBox="0 0 24 24" stroke="#2ecc71" fill="none"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>`,
   drops:[{i:'ü™ô',n:'–ú–æ–Ω–µ—Ç—ã',v:'+50',coins:50},{i:'üéÅ',n:'–ü–æ–¥–∞—Ä–æ–∫',v:'—Ö1',inv:'gift',cnt:1},{i:'‚ö°',n:'–ë–æ–Ω—É—Å',v:'—Ö3',inv:'bonus3',cnt:1},{i:'üíé',n:'–ö—Ä–∏—Å—Ç–∞–ª–ª',v:'—Ö1',inv:'crystal',cnt:1},{i:'ü™ô',n:'–ú–æ–Ω–µ—Ç—ã',v:'+100',coins:100},{i:'üéüÔ∏è',n:'–ë–∏–ª–µ—Ç',v:'—Ö1',inv:'ticket',cnt:1},{i:'üèÜ',n:'VIP',v:'1 –¥–µ–Ω—å',vipDays:1},{i:'ü™ô',n:'–ú–æ–Ω–µ—Ç—ã',v:'+30',coins:30}]},
  {id:2,name:'–û–±—ã—á–Ω—ã–π',price:150,bg:'linear-gradient(145deg,#0d1428,#101828)',ic:'#5B8DEF',ib:'rgba(91,141,239,.15)',
   icon:`<svg viewBox="0 0 24 24" stroke="#5B8DEF" fill="none"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/><line x1="12" y1="12" x2="12" y2="16"/><line x1="10" y1="14" x2="14" y2="14"/></svg>`,
   drops:[{i:'üí∞',n:'–ú–æ–Ω–µ—Ç—ã',v:'+200',coins:200},{i:'üéÅ',n:'–ü–æ–¥–∞—Ä–æ–∫',v:'—Ö2',inv:'gift',cnt:2},{i:'üíé',n:'–ö—Ä–∏—Å—Ç–∞–ª–ª',v:'—Ö2',inv:'crystal',cnt:2},{i:'üèÜ',n:'VIP',v:'3 –¥–Ω—è',vipDays:3},{i:'‚≠ê',n:'–ú–æ–Ω–µ—Ç—ã',v:'+100',coins:100},{i:'üéüÔ∏è',n:'–ë–∏–ª–µ—Ç',v:'—Ö3',inv:'ticket',cnt:3},{i:'üåü',n:'–°—É–ø–µ—Ä',v:'—Ö1',inv:'super',cnt:1},{i:'üí∞',n:'–ú–æ–Ω–µ—Ç—ã',v:'+150',coins:150}]},
  {id:3,name:'–ó–æ–ª–æ—Ç–æ–π',price:500,bg:'linear-gradient(145deg,#1a1500,#1e1800)',ic:'#F4C430',ib:'rgba(244,196,48,.15)',
   icon:`<svg viewBox="0 0 24 24" stroke="#F4C430" fill="none"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`,
   drops:[{i:'üí∞',n:'–ú–æ–Ω–µ—Ç—ã',v:'+1000',coins:1000},{i:'üèÜ',n:'VIP',v:'7 –¥–Ω–µ–π',vipDays:7},{i:'üíé',n:'–ö—Ä–∏—Å—Ç–∞–ª–ª',v:'—Ö5',inv:'crystal',cnt:5},{i:'üéÅ',n:'–ü–æ–¥–∞—Ä–æ–∫',v:'—Ö5',inv:'gift',cnt:5},{i:'üåü',n:'–°—É–ø–µ—Ä',v:'—Ö1',inv:'super',cnt:1},{i:'üëë',n:'–ö–æ—Ä–æ–Ω–∞',v:'–Ω–∞–≤—Å–µ–≥–¥–∞',inv:'crown',cnt:1},{i:'üí∞',n:'–ú–æ–Ω–µ—Ç—ã',v:'+2000',coins:2000},{i:'üî•',n:'–ë–æ–Ω—É—Å',v:'—Ö5',inv:'bonus5',cnt:1}]},
  {id:4,name:'–ü—Ä–µ–º–∏—É–º',price:1000,bg:'linear-gradient(145deg,#200a0a,#1a0808)',ic:'#FF4D4D',ib:'rgba(255,77,77,.15)',
   icon:`<svg viewBox="0 0 24 24" stroke="#FF4D4D" fill="none"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/><circle cx="12" cy="12" r="3"/></svg>`,
   drops:[{i:'üëë',n:'–ö–æ—Ä–æ–Ω–∞',v:'–Ω–∞–≤—Å–µ–≥–¥–∞',inv:'crown',cnt:1},{i:'üí∞',n:'–ú–æ–Ω–µ—Ç—ã',v:'+5000',coins:5000},{i:'üèÜ',n:'VIP',v:'30 –¥–Ω–µ–π',vipDays:30},{i:'‚ú®',n:'–õ–µ–≥–µ–Ω–¥–∞',v:'14 –¥–Ω–µ–π',inv:'legend',cnt:1},{i:'üåü',n:'–°—É–ø–µ—Ä',v:'—Ö1',inv:'super',cnt:1},{i:'üéÅ',n:'–ú–µ–≥–∞-–ø–æ–¥–∞—Ä–æ–∫',v:'—Ö1',inv:'megagift',cnt:1},{i:'üí∞',n:'–ú–æ–Ω–µ—Ç—ã',v:'+10000',coins:10000},{i:'üèÜ',n:'VIP',v:'7 –¥–Ω–µ–π',vipDays:7}]},
];

/* ‚ïê‚ïê SHOP ITEMS ‚ïê‚ïê */
const ITEMS=[
  {id:2,ico:'üíé',name:'–ö—Ä–∏—Å—Ç–∞–ª–ª —É–¥–∞—á–∏',price:300,wip:false},
  {id:3,ico:'üèÜ',name:'VIP –Ω–∞ 7 –¥–Ω–µ–π',price:500,wip:false,vipDays:7},
  {id:7,ico:'üëë',name:'VIP –Ω–∞ 30 –¥–Ω–µ–π',price:1500,wip:false,vipDays:30},
  {id:4,ico:'üé∞',name:'–î–æ–ø. –ø–æ–ø—ã—Ç–∫–∞',price:200,wip:true},
  {id:5,ico:'üåà',name:'–¶–≤–µ—Ç–Ω–æ–π –Ω–∏–∫',price:250,wip:false,special:'color'},
  {id:6,ico:'‚ú®',name:'–ë—É—Å—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤',price:400,wip:true},
];

/* ‚ïê‚ïê TASKS ‚ïê‚ïê */
const TASKS=[
  {id:1,ico:'üì¢',tag:'–ö–∞–Ω–∞–ª',tc:'r',name:'–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª',desc:'–ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ @broketalking',rew:100,url:'https://t.me/broketalking',check:'sub'},
  {id:2,ico:'üí¨',tag:'–ó–∞–¥–∞–Ω–∏–µ',tc:'r',name:'–ù–∞–ø–∏—Å–∞—Ç—å –≤ —á–∞—Ç',desc:'–ù–∞–ø–∏—à–∏ –ª—é–±–æ–µ —Å–ª–æ–≤–æ –≤ @drainself',rew:50,url:'https://t.me/drainself',check:'chat'},
  {id:4,ico:'üë•',tag:'–î—Ä—É–∑—å—è',tc:'g',name:'–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –ø–µ—Ä–≤–æ–≥–æ –¥—Ä—É–≥–∞',desc:'–ü—Ä–∏–≥–ª–∞—Å–∏ –ø–æ —Ä–µ—Ñ-—Å—Å—ã–ª–∫–µ',rew:1000,check:'ref'},
  {id:6,ico:'üì¶',tag:'–ó–∞–¥–∞–Ω–∏–µ',tc:'r',name:'–û—Ç–∫—Ä—ã—Ç—å –ø–µ—Ä–≤—ã–π –∫–µ–π—Å',desc:'–û—Ç–∫—Ä–æ–π –ª—é–±–æ–π –∫–µ–π—Å –≤ –ú–∞–≥–∞–∑–∏–Ω–µ',rew:200,check:'case'},
];

/* ‚ïê‚ïê NICK COLORS ‚ïê‚ïê */
const COLORS=[
  {id:'nc-purple',label:'–§–∏–æ–ª–µ—Ç–æ–≤—ã–π',grad:'linear-gradient(135deg,#bf5af2,#e040fb,#da8fff)',tc:'#bf5af2'},
  {id:'nc-gold',  label:'–ó–æ–ª–æ—Ç–æ–π',   grad:'linear-gradient(135deg,#f4c430,#ffab00,#f39c12)',tc:'#f4c430'},
  {id:'nc-red',   label:'–ö—Ä–∞—Å–Ω—ã–π',   grad:'linear-gradient(135deg,#ff6060,#ff2d2d,#ff4444)',tc:'#ff4444'},
  {id:'nc-blue',  label:'–°–∏–Ω–∏–π',     grad:'linear-gradient(135deg,#5b8def,#4a7adc,#3a5bbe)',tc:'#5b8def'},
  {id:'nc-pink',  label:'–†–æ–∑–æ–≤—ã–π',   grad:'linear-gradient(135deg,#ff6fb7,#ff4daa,#ff2299)',tc:'#ff4daa'},
  {id:'nc-cyan',  label:'–ì–æ–ª—É–±–æ–π',   grad:'linear-gradient(135deg,#00e5ff,#00b4d8,#0077b6)',tc:'#00e5ff'},
  {id:'',         label:'–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π',grad:'linear-gradient(135deg,#fff,#2ecc71)',tc:'#2ecc71'},
];

const LEGEND_COLORS=['#2ecc71','#bf5af2','#f4c430','#ff6060','#5b8def','#ff6fb7','#00e5ff','#ff7f00'];

/* ‚ïê‚ïê NAVIGATION ‚ïê‚ïê */
const PAGES=['home','tasks','shop','inventory','raffles','friends','profile'];
let curPage='home',navLk=false;

function go(name){
  if(name===curPage||navLk)return;
  navLk=true;
  const old=document.getElementById('page-'+curPage);
  const nw=document.getElementById('page-'+name);
  old.classList.add('exit');
  old.addEventListener('animationend',()=>{old.classList.remove('active','exit');old.style.display='none';},{once:true});
  setTimeout(()=>{nw.style.display='block';nw.classList.add('active');nw.addEventListener('animationend',()=>{navLk=false;},{once:true});},60);
  PAGES.forEach(p=>document.getElementById('nb-'+p)?.classList.remove('active'));
  document.getElementById('nb-'+name)?.classList.add('active');
  curPage=name;syncB();
  if(name==='inventory')renderInv();
}

/* ‚ïê‚ïê SYNC ‚ïê‚ïê */
function syncB(){
  const b=S.balance.toLocaleString('ru');
  ['home','tasks','shop','inv','raffles','friends','profile'].forEach(k=>{const el=document.getElementById('b-'+k);if(el)el.textContent=b;});
  document.getElementById('p-bal').textContent=S.balance.toLocaleString('ru');
  save();
}

/* ‚ïê‚ïê VIP ‚ïê‚ïê */
function vipStatus(){if(!S.vipExpiry)return'none';return Date.now()<S.vipExpiry?'active':'expired';}
function activateVip(days){const now=Date.now();S.vipExpiry=(S.vipExpiry&&S.vipExpiry>now?S.vipExpiry:now)+days*86400000;save();updateVipUI();}
function updateVipUI(){
  const el=document.getElementById('p-vip');if(!el)return;
  const st=vipStatus();
  if(st==='active'){const d=Math.ceil((S.vipExpiry-Date.now())/86400000);el.innerHTML=`<span class="vip-active">‚úÖ VIP –∞–∫—Ç–∏–≤–µ–Ω (${d} –¥–Ω.)</span>`;}
  else if(st==='expired'){el.innerHTML=`<span class="vip-expired">‚ö†Ô∏è VIP –∏—Å—Ç—ë–∫</span>`;}
  else{el.innerHTML=`<span class="vip-none">‚ùå VIP –Ω–µ—Ç</span>`;}
}

/* ‚ïê‚ïê NICK COLOR ‚ïê‚ïê */
function applyNick(cid){
  S.nickColor=cid;save();
  const w=document.getElementById('h-name-wrap');
  if(w){w.className='uname '+(cid||'nc-default');}
  const pc=document.getElementById('p-color');
  const c=COLORS.find(x=>x.id===cid);
  if(pc)pc.textContent=c?c.label:'–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π';
  // Also update profile name color
  const pn=document.getElementById('p-name');
  if(pn&&cid){pn.style.background=c.grad;pn.style.webkitBackgroundClip='text';pn.style.webkitTextFillColor='transparent';pn.style.backgroundClip='text';}
  else if(pn){pn.style.background='';pn.style.webkitTextFillColor='';}
}

/* ‚ïê‚ïê CROWN ‚ïê‚ïê */
function applyCrown(){
  if(!S.hasCrown)return;
  document.getElementById('crown-h')?.classList.add('show');
  document.getElementById('crown-p')?.classList.add('show');
}

/* ‚ïê‚ïê LEGEND ‚ïê‚ïê */
function applyLegend(){
  if(!S.legendExpiry||Date.now()>S.legendExpiry)return;
  const col=S.legendColor;
  ['av-wrap-h','av-wrap-p'].forEach(id=>{
    const el=document.getElementById(id);
    if(el){el.classList.add('legend-glow');el.style.setProperty('--legend-color',col);}
  });
}

/* ‚ïê‚ïê INVENTORY ‚ïê‚ïê */
function addInv(key,cnt){S.inventory[key]=(S.inventory[key]||0)+cnt;save();}
function removeInv(key,cnt=1){S.inventory[key]=Math.max(0,(S.inventory[key]||0)-cnt);if(!S.inventory[key])delete S.inventory[key];save();}
function invCount(key){return S.inventory[key]||0;}

function renderInv(){
  const el=document.getElementById('inv-list');if(!el)return;
  const keys=Object.keys(S.inventory).filter(k=>S.inventory[k]>0);
  if(!keys.length){
    el.innerHTML=`<div class="inv-empty"><div class="inv-empty-ico">üì¶</div><div class="inv-empty-t">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</div><div class="inv-empty-s">–û—Ç–∫—Ä—ã–≤–∞–π –∫–µ–π—Å—ã —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç—ã</div></div>`;
    return;
  }
  el.innerHTML=keys.map(k=>{
    const d=INV_DEF[k]||{ico:'‚ùì',name:k,desc:'',action:''};
    return`<div class="gc inv-item" onclick="useInvItem('${k}')">
      <div class="inv-ico">${d.ico}</div>
      <div class="inv-info"><div class="inv-name">${d.name}</div><div class="inv-desc">${d.desc}</div></div>
      <div class="inv-cnt">√ó${S.inventory[k]}</div>
    </div>`;
  }).join('');
}

function useInvItem(key){
  const d=INV_DEF[key];if(!d)return;
  const cnt=invCount(key);if(!cnt)return;
  const a=d.action;
  if(a==='openGift'){
    const coins=Math.floor(Math.random()*401)+100;
    openGenMo('üéÅ –û—Ç–∫—Ä—ã—Ç—å –ø–æ–¥–∞—Ä–æ–∫',`–ü–æ–ª—É—á–∏ —Å–ª—É—á–∞–π–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç (100‚Äì500)\n–£ –≤–∞—Å: √ó${cnt}`,`üéÅ –û—Ç–∫—Ä—ã—Ç—å`,()=>{
      removeInv('gift',1);S.balance+=coins;syncB();closeGenMo();
      toast(`üéÅ –ü–æ–ª—É—á–µ–Ω–æ +${coins} –º–æ–Ω–µ—Ç!`,'g');renderInv();
    });
  } else if(a==='usecrystal'){
    const c=invCount('crystal');
    openGenMo('üíé –ö—Ä–∏—Å—Ç–∞–ª–ª—ã —Å–∫–∏–¥–∫–∏',`–£ –≤–∞—Å ${c} –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤.\n–ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ 10+ –º–æ–∂–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–∫–∏–¥–∫—É 50% –Ω–∞ VIP 7 –¥–Ω–µ–π (–±—É–¥–µ—Ç —Å—Ç–æ–∏—Ç—å 250 –≤–º–µ—Å—Ç–æ 500).${S.vipDiscount?'\n\n‚úÖ –°–∫–∏–¥–∫–∞ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞!':''}`,
      c>=10&&!S.vipDiscount?'üíé –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–∫–∏–¥–∫—É':'–ó–∞–∫—Ä—ã—Ç—å',()=>{
      if(c>=10&&!S.vipDiscount){removeInv('crystal',10);S.vipDiscount=true;save();closeGenMo();toast('üíé –°–∫–∏–¥–∫–∞ 50% –Ω–∞ VIP –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!','g');rShopItems();}
      else{closeGenMo();}
    });
  } else if(a==='activateBonus3'){
    openGenMo('‚ö° –ë–æ–Ω—É—Å √ó3',`–°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω–µ–∂–Ω—ã–π –ø—Ä–∏–∑ –≤ –∫–µ–π—Å–µ –±—É–¥–µ—Ç —É–º–Ω–æ–∂–µ–Ω –Ω–∞ 3!\n–î–µ–π—Å—Ç–≤—É–µ—Ç 1 —Ä–∞–∑ –∏ –∏—Å—á–µ–∑–Ω–µ—Ç –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è.${S.bonusMulti?'\n\n‚ö†Ô∏è –£–∂–µ –∞–∫—Ç–∏–≤–µ–Ω –±–æ–Ω—É—Å √ó'+S.bonusMulti:''}`,
      '‚ö° –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å',()=>{removeInv('bonus3',1);S.bonusMulti=3;save();closeGenMo();toast('‚ö° –ë–æ–Ω—É—Å √ó3 –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!','g');renderInv();});
  } else if(a==='activateBonus5'){
    openGenMo('üî• –ë–æ–Ω—É—Å √ó5',`–°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω–µ–∂–Ω—ã–π –ø—Ä–∏–∑ –≤ –∫–µ–π—Å–µ –±—É–¥–µ—Ç —É–º–Ω–æ–∂–µ–Ω –Ω–∞ 5!\n–î–µ–π—Å—Ç–≤—É–µ—Ç 1 —Ä–∞–∑.${S.bonusMulti?'\n\n‚ö†Ô∏è –£–∂–µ –∞–∫—Ç–∏–≤–µ–Ω –±–æ–Ω—É—Å √ó'+S.bonusMulti:''}`,
      'üî• –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å',()=>{removeInv('bonus5',1);S.bonusMulti=5;save();closeGenMo();toast('üî• –ë–æ–Ω—É—Å √ó5 –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!','g');renderInv();});
  } else if(a==='useTicket'){
    openGenMo('üéüÔ∏è –ë–∏–ª–µ—Ç','–ë–∏–ª–µ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è —É—á–∞—Å—Ç–∏—è –≤ –ø–ª–∞—Ç–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–∞—Ö.\n–ü–æ–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π —Å –±–∏–ª–µ—Ç–∞–º–∏ –Ω–µ—Ç.','–ó–∞–∫—Ä—ã—Ç—å',()=>closeGenMo());
  } else if(a==='useSuper'){
    openGenMo('üåü –°—É–ø–µ—Ä','–ü–æ–∑–≤–æ–ª—è–µ—Ç —Å–º–µ–Ω–∏—Ç—å —Ü–≤–µ—Ç –Ω–∏–∫–∞ 1 —Ä–∞–∑ –±–µ—Å–ø–ª–∞—Ç–Ω–æ.\n–ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –ø—Ä–µ–¥–º–µ—Ç —Å–ø–∏—à–µ—Ç—Å—è.','üåü –í—ã–±—Ä–∞—Ç—å —Ü–≤–µ—Ç',()=>{closeGenMo();removeInv('super',1);save();renderInv();openColorPicker(true);});
  } else if(a==='wearCrown'){
    openGenMo('üëë –ö–æ—Ä–æ–Ω–∞','–ù–∞–¥–µ–Ω—å –∫–æ—Ä–æ–Ω—É –Ω–∞ –∞–≤–∞—Ç–∞—Ä–∫—É –Ω–∞–≤—Å–µ–≥–¥–∞!\n–ö–æ—Ä–æ–Ω–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞–¥ —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ –∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ.','üëë –ù–∞–¥–µ—Ç—å',()=>{removeInv('crown',1);S.hasCrown=true;save();applyCrown();closeGenMo();toast('üëë –ö–æ—Ä–æ–Ω–∞ –Ω–∞–¥–µ—Ç–∞!','g');renderInv();});
  } else if(a==='activateLegendItem'){
    closeGenMo();
    // open legend color picker
    renderLegendColors();
    document.getElementById('lgmo').classList.add('show');
  } else if(a==='openMegaGift'){
    removeInv('megagift',1);save();renderInv();closeGenMo();
    openMegaGift();
  }
}

/* ‚ïê‚ïê LEGEND COLOR PICKER ‚ïê‚ïê */
let selLegCol=LEGEND_COLORS[0];
function renderLegendColors(){
  document.getElementById('lg-colors').innerHTML=LEGEND_COLORS.map(c=>`
    <div class="lgcitem${selLegCol===c?' sel':''}" style="background:${c}" onclick="selLegCol='${c}';renderLegendColors()"></div>`).join('');
}
function activateLegend(){
  if(!invCount('legend')){toast('–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–∞ –õ–µ–≥–µ–Ω–¥–∞','r');document.getElementById('lgmo').classList.remove('show');return;}
  removeInv('legend',1);
  S.legendExpiry=Date.now()+14*86400000;
  S.legendColor=selLegCol;
  save();applyLegend();
  document.getElementById('lgmo').classList.remove('show');
  toast('‚ú® –õ–µ–≥–µ–Ω–¥–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ 14 –¥–Ω–µ–π!','g');
  renderInv();
}

/* ‚ïê‚ïê TASKS ‚ïê‚ïê */
function renderTasks(){
  document.getElementById('tasks-list').innerHTML=TASKS.map(t=>{
    const done=S.doneTasks.has(t.id);
    return`<div class="gc ti" onclick="openTask(${t.id})">
      <div class="tico">${t.ico}</div>
      <div class="tinf">
        <div class="ttag ${t.tc}">${t.tag}</div>
        <div class="tname">${t.name}</div>
        <div class="tdesc">${t.desc}</div>
      </div>
      ${done?'<div class="tdone">‚úì</div>':`<div class="trew">+${t.rew}ü™ô</div>`}
    </div>`;
  }).join('');
}

function openTask(id){
  const t=TASKS.find(x=>x.id===id);if(!t)return;
  if(S.doneTasks.has(id)){toast('‚úÖ –£–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ','g');return;}
  if(t.check==='ref'){
    if(S.refs.length>0){completeTask(id);}
    else{openGenMo('üë• –ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞',`–ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞ –ø–æ —Ä–µ—Ñ-—Å—Å—ã–ª–∫–µ –∏ –ø–æ–ª—É—á–∏ +${t.rew} –º–æ–Ω–µ—Ç`,'üë• –ö —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º',()=>{closeGenMo();go('friends');});}
    return;
  }
  if(t.check==='case'){
    openGenMo('üì¶ –û—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å',`–û—Ç–∫—Ä–æ–π –ª—é–±–æ–π –∫–µ–π—Å –≤ –ú–∞–≥–∞–∑–∏–Ω–µ ‚Üí –ö–µ–π—Å—ã –∏ –ø–æ–ª—É—á–∏ +${t.rew} –º–æ–Ω–µ—Ç`,'üì¶ –í –º–∞–≥–∞–∑–∏–Ω',()=>{closeGenMo();go('shop');setTimeout(()=>{document.querySelectorAll('.stab')[1]?.click();},300);});
    return;
  }
  if(t.check==='sub'){
    openGenMo('üì¢ '+t.name,`–ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ @${t.channel} –∏ –≤–µ—Ä–Ω–∏—Å—å ‚Äî –Ω–∞–∂–º–∏ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É"`,
      'üì¢ –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –∫–∞–Ω–∞–ª',()=>{
        if(tg)tg.openTelegramLink(t.url);else window.open(t.url,'_blank');
        closeGenMo();
        // Show verify button after returning
        setTimeout(()=>showVerifyBtn(t),800);
      }
    );return;
  }
  if(t.check==='chat'){
    openGenMo('üí¨ '+t.name,`–ó–∞–π–¥–∏ –≤ @${t.channel}, –Ω–∞–ø–∏—à–∏ –ª—é–±–æ–µ —Å–ª–æ–≤–æ –∏ –≤–µ—Ä–Ω–∏—Å—å ‚Äî –Ω–∞–∂–º–∏ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å"`,
      'üí¨ –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç',()=>{
        if(tg)tg.openTelegramLink(t.url);else window.open(t.url,'_blank');
        closeGenMo();
        setTimeout(()=>showVerifyBtn(t),800);
      }
    );return;
  }
}

function showVerifyBtn(t){
  openGenMo(
    'üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–¥–∞–Ω–∏—è',
    t.check==='sub'
      ? `–ü–æ–¥–ø–∏—Å–∞–ª—Å—è –ª–∏ —Ç—ã –Ω–∞ @${t.channel}?`
      : `–ù–∞–ø–∏—Å–∞–ª –ª–∏ —Ç—ã —Å–ª–æ–≤–æ –≤ @${t.channel}?`,
    '‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å',
    ()=>verifyTask(t)
  );
  document.querySelector('#genmo .mbtn.gray').textContent='–ï—â—ë –Ω–µ –≤—ã–ø–æ–ª–Ω–∏–ª';
  document.querySelector('#genmo .mbtn.gray').onclick=()=>{
    closeGenMo();
    toast(t.check==='sub'?'–í—ã –Ω–µ –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å':'–í—ã –Ω–µ –Ω–∞–ø–∏—Å–∞–ª–∏ —Å–ª–æ–≤–æ –≤ —á–∞—Ç','r');
  };
}

async function verifyTask(t){
  const uid=UID;
  document.getElementById('gm-a').textContent='–ü—Ä–æ–≤–µ—Ä—è–µ–º...';
  document.getElementById('gm-a').disabled=true;
  try{
    if(t.check==='sub'){
      const r=await fetch('/api/check-sub',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:uid,channel:t.channel})});
      const d=await r.json();
      if(d.subscribed){completeTask(t.id);}
      else{closeGenMo();toast('–í—ã –Ω–µ –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å','r');}
    } else if(t.check==='chat'){
      const r=await fetch('/api/check-chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:uid,channel:t.channel})});
      const d=await r.json();
      if(d.member){completeTask(t.id);}
      else{closeGenMo();toast('–í—ã –Ω–µ –≤ —á–∞—Ç–µ','r');}
    }
  }catch(e){
    closeGenMo();toast('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑','r');
  }
  document.getElementById('gm-a').disabled=false;
}

function completeTask(id){
  S.doneTasks.add(id);
  const t=TASKS.find(x=>x.id===id);
  if(t){S.balance+=t.rew;syncB();}
  closeGenMo();renderTasks();
  toast(`+${t?.rew||0} –º–æ–Ω–µ—Ç! üéâ`,'g');
}

/* ‚ïê‚ïê SHOP ‚ïê‚ïê */
function shopTab(tab,btn){
  document.querySelectorAll('.stab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('shop-items').style.display=tab==='items'?'grid':'none';
  document.getElementById('shop-cases').style.display=tab==='cases'?'grid':'none';
}

function rShopItems(){
  document.getElementById('shop-items').innerHTML=ITEMS.map(x=>{
    const ok=S.balance>=x.price;
    let btn,price=x.price;
    if(x.id===3&&S.vipDiscount)price=250;
    const ok2=S.balance>=price;
    if(x.wip)btn=`<button class="sbuy wip" disabled>–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</button>`;
    else if(x.special==='color')btn=`<button class="sbuy" onclick="openColorPicker(false)">–í—ã–±—Ä–∞—Ç—å —Ü–≤–µ—Ç</button>`;
    else btn=`<button class="sbuy${ok2?'':' nomoney'}"${ok2?'':' disabled'} onclick="buyItem(${x.id})">${ok2?'–ö—É–ø–∏—Ç—å':'–ú–∞–ª–æ –º–æ–Ω–µ—Ç'}</button>`;
    const priceLabel=x.id===3&&S.vipDiscount?`<span style="text-decoration:line-through;opacity:.5">${x.price}</span> <span style="color:var(--green)">${price} ü™ô</span>`:`${price} ü™ô`;
    return`<div class="gc sitem">
      <div class="sico">${x.ico}</div>
      <div class="sname">${x.name}</div>
      <div class="sprice">${priceLabel}</div>
      ${btn}
    </div>`;
  }).join('');
}

function buyItem(id){
  const x=ITEMS.find(i=>i.id===id);if(!x)return;
  let price=x.price;
  if(id===3&&S.vipDiscount)price=250;
  if(S.balance<price)return;
  openGenMo(`–ö—É–ø–∏—Ç—å ${x.name}?`,`–°–ø–∏—à–µ—Ç—Å—è ${price} –º–æ–Ω–µ—Ç`,`üõí –ö—É–ø–∏—Ç—å ‚Äî ${price} ü™ô`,()=>{
    S.balance-=price;
    if(x.vipDays){activateVip(x.vipDays);if(id===3&&S.vipDiscount){S.vipDiscount=false;save();}}
    syncB();rShopItems();closeGenMo();
    toast(`${x.ico} ${x.vipDays?'VIP –Ω–∞ '+x.vipDays+' –¥–Ω. –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!':'–ö—É–ø–ª–µ–Ω–æ!'}`,'g');
  });
}

/* ‚ïê‚ïê COLOR PICKER ‚ïê‚ïê */
let selColor='',freeColor=false;
function openColorPicker(free=false){
  freeColor=free;selColor=S.nickColor;
  document.getElementById('cp-grid').innerHTML=COLORS.map(c=>`
    <div class="cpitem${selColor===c.id?' sel':''}" style="background:${c.grad};color:#000" onclick="selColor='${c.id}';document.querySelectorAll('.cpitem').forEach(e=>e.classList.remove('sel'));this.classList.add('sel')">${c.label}</div>`).join('');
  document.getElementById('cp-btn').textContent=free?'‚ú® –ü—Ä–∏–º–µ–Ω–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ':'–ö—É–ø–∏—Ç—å ‚Äî 250 ü™ô';
  document.getElementById('cpmo').classList.add('show');
}
function buyColor(){
  if(!freeColor&&S.balance<250){toast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç','r');return;}
  if(!freeColor){S.balance-=250;syncB();}
  applyNick(selColor);
  document.getElementById('cpmo').classList.remove('show');
  toast('üåà –¶–≤–µ—Ç –Ω–∏–∫–∞ –∏–∑–º–µ–Ω—ë–Ω!','g');
}

/* ‚ïê‚ïê CASES ‚ïê‚ïê */
function rCases(){
  document.getElementById('shop-cases').innerHTML=CASES.map(c=>`
    <div class="gc ccard" onclick="openCaseMo(${c.id})">
      <div class="ccimg" style="background:${c.bg}"><div class="ccimg-ico" style="background:${c.ib};border:1px solid ${c.ic}40">${c.icon}</div></div>
      <div class="ccinfo">
        <div class="ccname">${c.name}</div>
        <div class="ccprice"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>${c.price}</div>
        <button class="ccpvbtn" onclick="event.stopPropagation();showPrizePrev(${c.id})">üëÅ –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏–∑—ã</button>
      </div>
    </div>`).join('');
}

function showPrizePrev(id){
  const c=CASES.find(x=>x.id===id);if(!c)return;
  document.getElementById('pv-t').textContent=`üì¶ ${c.name}`;
  document.getElementById('pv-grid').innerHTML=c.drops.map(d=>`<div class="pvitem"><div class="pvico">${d.i}</div><div class="pvname">${d.n}</div><div class="pvval">${d.v}</div></div>`).join('');
  document.getElementById('pvmo').classList.add('show');
}

/* ‚ïê‚ïê CASE ROULETTE ‚ïê‚ïê */
let curC=null,spinning=false;
const IW=89;

function openCaseMo(id){
  curC=CASES.find(c=>c.id===id);if(!curC)return;
  spinning=false;
  document.getElementById('cm-t').textContent=curC.name;
  document.getElementById('cm-cost').textContent=`–°—Ç–æ–∏–º–æ—Å—Ç—å: ${curC.price} ü™ô`;
  const btn=document.getElementById('cm-btn');
  btn.disabled=S.balance<curC.price;
  btn.textContent=S.balance<curC.price?`–ù—É–∂–Ω–æ ${curC.price} ü™ô`:'üé∞ –û—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å';
  document.getElementById('cm-spin').style.display='block';
  document.getElementById('cres').classList.remove('show');
  buildReel('rtrack',curC.drops);
  document.getElementById('cmo').classList.add('show');
}

function buildReel(trackId,drops){
  const track=document.getElementById(trackId);
  let items=[];for(let i=0;i<10;i++)items.push(...drops);
  track.innerHTML=items.map((d,idx)=>`<div class="ritem" id="${trackId}-${idx}"><div class="rico">${d.i}</div><div class="rname">${d.n}</div><div class="rval">${d.v}</div></div>`).join('');
  track.style.transition='none';track.style.transform='translateX(0)';
}

function spinReel(trackId,drops,onWin){
  const track=document.getElementById(trackId);
  const total=drops.length*10;
  const winIdx=Math.floor(total/2)+Math.floor(Math.random()*drops.length);
  const cw=track.parentElement.clientWidth;
  const tx=-(winIdx*IW-cw/2+IW/2);
  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    track.style.transition='transform 5s cubic-bezier(0.1,0.82,0.05,1)';
    track.style.transform=`translateX(${tx}px)`;
  }));
  setTimeout(()=>{
    document.querySelectorAll(`#${trackId} .ritem`).forEach(el=>el.classList.remove('win'));
    document.getElementById(`${trackId}-${winIdx}`)?.classList.add('win');
    setTimeout(()=>onWin(drops[winIdx%drops.length]),600);
  },5000);
}

function spinCase(){
  if(spinning||!curC)return;
  if(S.balance<curC.price){toast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!','r');return;}
  spinning=true;S.balance-=curC.price;syncB();
  spinReel('rtrack',curC.drops,(winner)=>{
    spinning=false;
    // Apply bonus multiplier to coins
    let coins=winner.coins||0;
    if(coins>0&&S.bonusMulti>1){coins*=S.bonusMulti;S.bonusMulti=0;save();toast(`‚ö° –ë–æ–Ω—É—Å –ø—Ä–∏–º–µ–Ω—ë–Ω!`,'g');}
    if(coins>0){S.balance+=coins;syncB();}
    if(winner.vipDays){activateVip(winner.vipDays);}
    if(winner.inv){addInv(winner.inv,winner.cnt||1);}
    document.getElementById('cm-spin').style.display='none';
    const r=document.getElementById('cres');r.classList.add('show');
    document.getElementById('cr-ico').textContent=winner.i;
    document.getElementById('cr-t').textContent='–í—ã –ø–æ–ª—É—á–∏–ª–∏: '+winner.n;
    document.getElementById('cr-s').textContent=coins>0?`+${coins} –º–æ–Ω–µ—Ç`:winner.v;
    toast('üéâ '+winner.n+'!','g');
    if(!S.doneTasks.has(6)){completeTask(6);}
    rShopItems();
  });
}

function closeCase(){document.getElementById('cmo').classList.remove('show');spinning=false;rShopItems();rCases();}

/* ‚ïê‚ïê MEGA GIFT ‚ïê‚ïê */
const MEGA_DROPS=[
  {i:'üèÜ',n:'VIP',v:'7 –¥–Ω–µ–π',vipDays:7},
  {i:'üéüÔ∏è',n:'–ë–∏–ª–µ—Ç—ã',v:'—Ö10',inv:'ticket',cnt:10},
  {i:'üëë',n:'–ö–æ—Ä–æ–Ω–∞',v:'14 –¥–Ω–µ–π',inv:'crown',cnt:1},
  {i:'üì¶',n:'–ö–µ–π—Å –ó–æ–ª–æ—Ç–æ–π',v:'–±–µ—Å–ø–ª–∞—Ç–Ω–æ',freeCase:3},
];
let megaSpinning=false;
function openMegaGift(){
  megaSpinning=false;
  document.getElementById('mega-spin').style.display='block';
  document.getElementById('mega-res').classList.remove('show');
  document.getElementById('mega-btn').disabled=false;
  buildReel('mega-rtrack',MEGA_DROPS);
  document.getElementById('megamo').classList.add('show');
}
function spinMega(){
  if(megaSpinning)return;
  megaSpinning=true;
  document.getElementById('mega-btn').disabled=true;
  spinReel('mega-rtrack',MEGA_DROPS,(winner)=>{
    megaSpinning=false;
    if(winner.vipDays)activateVip(winner.vipDays);
    if(winner.inv)addInv(winner.inv,winner.cnt||1);
    if(winner.freeCase){curC=CASES.find(c=>c.id===winner.freeCase);if(curC){S.balance+=curC.price;}}
    document.getElementById('mega-spin').style.display='none';
    const r=document.getElementById('mega-res');r.classList.add('show');
    document.getElementById('mr-ico').textContent=winner.i;
    document.getElementById('mr-t').textContent='–í—ã –ø–æ–ª—É—á–∏–ª–∏: '+winner.n;
    document.getElementById('mr-s').textContent=winner.v;
    toast('üéâ '+winner.n+'!','g');
    syncB();renderInv();
  });
}

/* ‚ïê‚ïê FRIENDS ‚ïê‚ïê */
function rRefStats(){
  document.getElementById('ref-c1').textContent=S.refs.length;
  document.getElementById('ref-e').innerHTML=`<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>${S.refEarned.toLocaleString('ru')}`;
  const cnt=Math.min(S.refs.length,3);
  document.getElementById('ref-pb').style.width=(cnt/3*100)+'%';
  document.getElementById('ref-pt').textContent=cnt+' / 3';
  document.getElementById('p-refs').textContent=S.refs.length;
}
function rRefList(){
  const el=document.getElementById('ref-list');if(!el)return;
  if(!S.refs.length){el.innerHTML=`<div class="norefs"><div class="nrico">üë•</div><div class="nrt">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</div></div>`;return;}
  el.innerHTML=S.refs.map(r=>`<div class="gc" style="padding:10px 13px;margin-bottom:7px;display:flex;align-items:center;gap:10px">
    <div style="width:34px;height:34px;border-radius:50%;background:var(--gdim);border:1px solid var(--gbor);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0">üë§</div>
    <div style="flex:1"><div style="font-size:13px;font-weight:600">${r.name}</div><div style="font-size:10px;color:var(--muted2)">${r.date}</div></div>
    <div style="color:var(--green);font-size:11px;font-weight:700">+1000 ü™ô</div>
  </div>`).join('');
}
function copyRef(){navigator.clipboard?.writeText(document.getElementById('ref-link').textContent).catch(()=>{});toast('üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!','g');}
function shareRef(){
  const t=document.getElementById('ref-link').textContent;
  const msg=encodeURIComponent('üéÅ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ GiftBot ‚Äî –ø–æ–ª—É—á–∏ 1000 –º–æ–Ω–µ—Ç!');
  if(tg)tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(t)}&text=${msg}`);else copyRef();
}

/* ‚ïê‚ïê PROMO ‚ïê‚ïê */
async function usePromo(inputId){
  const el=document.getElementById(inputId);
  const code=(el.value||'').trim().toUpperCase();
  if(!code){toast('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥','r');return;}
  if(S.usedPromos.has(code)){toast('‚ùå –£–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω','r');el.value='';return;}
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –∏–¥—ë—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞
  el.disabled=true;
  const btn=el.nextElementSibling;
  const oldTxt=btn.textContent;btn.textContent='...';btn.disabled=true;
  try{
    const isVip=S.vipExpiry&&Date.now()<S.vipExpiry;
    const r=await fetch('/api/promo',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({code,userId:UID,isVip})
    });
    const d=await r.json();
    if(d.ok){
      S.usedPromos.add(code);
      S.balance=d.balance; // –±–µ—Ä—ë–º –±–∞–ª–∞–Ω—Å —Å —Å–µ—Ä–≤–µ—Ä–∞
      el.value='';
      syncB();rShopItems();
      toast(`‚úÖ +${d.reward} –º–æ–Ω–µ—Ç!`,'g');
    } else {
      toast(d.error||'‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥','r');
    }
  }catch(e){
    // Fallback ‚Äî –µ—Å–ª–∏ –Ω–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (—Ç–µ—Å—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ)
    toast('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º','r');
  }
  el.disabled=false;btn.textContent=oldTxt;btn.disabled=false;
}

/* ‚ïê‚ïê GENERAL MODAL ‚ïê‚ïê */
let _gmCb=null;
function openGenMo(title,sub,label,cb){
  document.getElementById('gm-t').textContent=title;
  document.getElementById('gm-s').textContent=sub;
  document.getElementById('gm-extra').innerHTML='';
  const a=document.getElementById('gm-a');a.textContent=label;a.className='mbtn g';
  document.querySelector('#genmo .mbtn.gray').onclick=closeGenMo;
  _gmCb=cb;
  document.getElementById('genmo').classList.add('show');
}
function closeGenMo(){document.getElementById('genmo').classList.remove('show');_gmCb=null;}
function doGenMo(){if(_gmCb)_gmCb();}

/* ‚ïê‚ïê TOAST ‚ïê‚ïê */
let _tt;
function toast(msg,type='g'){
  const el=document.getElementById('toast');
  el.textContent=msg;el.className='toast '+type+' show';
  clearTimeout(_tt);_tt=setTimeout(()=>el.classList.remove('show'),2500);
}

/* ‚ïê‚ïê INIT ‚ïê‚ïê */
function init(){
  const name=TGU.first_name||'User';
  const uname=TGU.username?'@'+TGU.username:'–ë–µ–∑ username';
  function setAv(id){
    const el=document.getElementById(id);if(!el)return;
    if(TGU.photo_url){el.innerHTML=`<img src="${TGU.photo_url}" onerror="this.parentElement.textContent='${name[0].toUpperCase()}'">`;}
    else{el.textContent=name[0].toUpperCase();}
  }
  setAv('av-h');setAv('av-p');
  document.getElementById('h-name').textContent=name;
  document.getElementById('p-name').textContent=name;
  document.getElementById('p-un').textContent=uname;
  document.getElementById('p-reg').textContent=S.regDate;
  document.getElementById('p-refs').textContent=S.refs.length;
  document.getElementById('ref-link').textContent=`https://t.me/SATapp_bot?start=ref_${UID}`;
  applyNick(S.nickColor);
  applyCrown();
  applyLegend();
  updateVipUI();
  syncB();
  renderTasks();
  rShopItems();
  rCases();
  rRefStats();
  rRefList();
  document.getElementById('pi-h').addEventListener('keydown',e=>{if(e.key==='Enter')usePromo('pi-h');});
  document.getElementById('pi-p').addEventListener('keydown',e=>{if(e.key==='Enter')usePromo('pi-p');});
}
init();
</script>
</body>
</html>