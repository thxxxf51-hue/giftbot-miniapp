<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>GiftBot</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#0a0a0a;--glass:rgba(28,30,32,0.88);--glass-border:rgba(255,255,255,0.07);
  --green:#2ecc71;--green2:#27ae60;--gdim:rgba(46,204,113,0.12);--gbor:rgba(46,204,113,0.25);
  --red:#ff6060;--rdim:rgba(255,96,96,0.12);--orange:#f39c12;
  --text:#f0f0f0;--muted:#555;--muted2:#777;--nav:#111213;
}
html,body{background:var(--bg);color:var(--text);font-family:-apple-system,'SF Pro Display','Helvetica Neue',sans-serif;height:100%;overflow:hidden;overscroll-behavior:none}
.app{display:flex;flex-direction:column;height:100vh;height:100dvh;background:var(--bg)}
.pages{flex:1;overflow:hidden;position:relative}
.page{display:none;position:absolute;inset:0;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding:16px 14px calc(62px + env(safe-area-inset-bottom));overscroll-behavior-y:contain;will-change:transform,opacity}
.page::-webkit-scrollbar{display:none}
.page.active{display:block;animation:pageIn .28s cubic-bezier(.4,0,.2,1) forwards}
.page.exit{display:block;animation:pageOut .2s cubic-bezier(.4,0,.2,1) forwards;pointer-events:none}
@keyframes pageIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes pageOut{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(-6px)}}

/* NAV */
.nav{flex-shrink:0;display:flex;align-items:center;background:var(--nav);border-top:1px solid rgba(255,255,255,0.05);padding:0 8px;padding-bottom:env(safe-area-inset-bottom);height:calc(52px + env(safe-area-inset-bottom))}
.nb{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;cursor:pointer;color:var(--muted);font-size:10px;font-weight:500;border:none;background:none;font-family:inherit;transition:color .2s;padding:6px 2px;position:relative}
.nb svg{width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;transition:all .2s}
.nb.active{color:var(--green)}
.nb.active .nb-bg{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:40px;height:36px;border-radius:10px;background:var(--gdim);z-index:0}
.nb>*{position:relative;z-index:1}

/* GLASS */
.gc{background:var(--glass);backdrop-filter:blur(20px) saturate(140%);-webkit-backdrop-filter:blur(20px) saturate(140%);border:1px solid var(--glass-border);border-radius:16px;position:relative;overflow:hidden}
.gc::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.08),transparent)}
.gc::after{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,rgba(255,255,255,0.03) 0%,transparent 60%);pointer-events:none}

/* SHARED */
.phdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
.ptitle{font-size:24px;font-weight:800;letter-spacing:-.5px}
.bpill{display:flex;align-items:center;gap:5px;background:var(--gdim);border:1px solid var(--gbor);border-radius:20px;padding:6px 12px;font-size:15px;font-weight:700;color:var(--green);flex-shrink:0}
.bpill svg{width:15px;height:15px;stroke:var(--green);fill:none;stroke-width:2;stroke-linecap:round}
.sec{font-size:16px;font-weight:700;margin-bottom:12px;color:var(--text)}

/* TOAST */
.toast{position:fixed;top:16px;left:50%;transform:translateX(-50%) translateY(-80px);padding:9px 16px;border-radius:16px;font-size:13px;font-weight:600;z-index:9999;transition:transform .3s cubic-bezier(.34,1.5,.64,1);white-space:nowrap;pointer-events:none;max-width:85vw;text-align:center}
.toast.show{transform:translateX(-50%) translateY(0)}
.toast.green{background:#1a2e1a;border:1px solid rgba(46,204,113,.3);color:var(--green)}
.toast.red{background:#2e1a1a;border:1px solid rgba(255,96,96,.3);color:var(--red)}

/* HOME */
.hhdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.huser{display:flex;align-items:center;gap:11px}
.av{width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,#2ecc71,#1a7a40);display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;border:2px solid rgba(46,204,113,0.4);box-shadow:0 0 20px rgba(46,204,113,0.2);overflow:hidden;flex-shrink:0}
.av img{width:100%;height:100%;object-fit:cover}
.welcome{font-size:12px;color:var(--muted2);margin-bottom:3px}
.username-grad{font-size:20px;font-weight:800;display:flex;align-items:center;gap:6px}
.username-grad span{background:linear-gradient(135deg,#ffffff 0%,#2ecc71 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
/* —Ü–≤–µ—Ç–Ω–æ–π –Ω–∏–∫ */
.username-grad.grad-purple span{background:linear-gradient(135deg,#bf5af2,#da8fff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.username-grad.grad-gold span{background:linear-gradient(135deg,#f4c430,#f39c12);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.username-grad.grad-red span{background:linear-gradient(135deg,#ff6060,#ff4444);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.username-grad.grad-blue span{background:linear-gradient(135deg,#5b8def,#3a5bbe);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.username-grad.grad-pink span{background:linear-gradient(135deg,#ff6fb7,#ff4499);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}

/* MENU GRID */
.mgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
.mc{background:var(--glass);backdrop-filter:blur(20px) saturate(140%);-webkit-backdrop-filter:blur(20px) saturate(140%);border:1px solid var(--glass-border);border-radius:18px;padding:20px 12px 16px;display:flex;flex-direction:column;align-items:center;gap:10px;cursor:pointer;transition:transform .12s;user-select:none;position:relative;overflow:hidden}
.mc::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.08),transparent)}
.mc::after{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(155deg,rgba(255,255,255,0.03) 0%,transparent 55%);pointer-events:none}
.mc:active{transform:scale(.96)}
.mc-ico{width:44px;height:44px;border-radius:14px;background:var(--gdim);border:1px solid var(--gbor);display:flex;align-items:center;justify-content:center;position:relative;z-index:1}
.mc-ico svg{width:24px;height:24px;stroke:var(--green);fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round}
.mc-t{font-size:14px;font-weight:700;position:relative;z-index:1;text-align:center}
.mc-s{font-size:11px;color:var(--muted2);text-align:center;position:relative;z-index:1}

/* PROMO */
.pcard{padding:14px;margin-bottom:12px}
.plbl{display:flex;align-items:center;gap:7px;font-size:13px;font-weight:600;color:var(--green);margin-bottom:10px}
.prow{display:flex;gap:8px}
.pin{flex:1;background:rgba(0,0,0,0.4);border:1px solid rgba(255,255,255,0.08);border-radius:11px;padding:11px 13px;color:var(--muted2);font-size:14px;outline:none;font-family:inherit;transition:border-color .2s,color .2s}
.pin:focus{border-color:var(--green);color:var(--text)}
.pbtn{background:var(--green);color:#000;border:none;border-radius:11px;padding:11px 16px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;white-space:nowrap;transition:transform .1s}
.pbtn:active{transform:scale(.95);background:var(--green2)}

/* HOME RAFFLES */
.rahdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.seeall{background:var(--gdim);color:var(--green);border:none;border-radius:10px;padding:5px 12px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit}
.rarow{display:flex;gap:10px;overflow-x:auto;padding-bottom:4px}
.rarow::-webkit-scrollbar{display:none}

/* TASKS */
.ti{padding:13px 14px;display:flex;align-items:center;gap:13px;margin-bottom:8px;cursor:pointer;transition:transform .1s}
.ti:active{transform:scale(.98)}
.tico{width:42px;height:42px;border-radius:12px;background:var(--gdim);border:1px solid var(--gbor);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.tinf{flex:1;min-width:0}
.ttag{display:inline-block;border-radius:5px;padding:2px 6px;font-size:10px;font-weight:700;margin-bottom:3px;letter-spacing:.3px}
.ttag.r{background:var(--rdim);color:var(--red)}
.ttag.g{background:var(--gdim);color:var(--green)}
.tname{font-size:13px;font-weight:600;margin-bottom:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tdesc{font-size:11px;color:var(--muted2)}
.trew{color:var(--green);font-weight:700;font-size:12px;white-space:nowrap;flex-shrink:0}
.tdone{background:var(--gdim);color:var(--green);border-radius:8px;padding:4px 9px;font-size:11px;font-weight:700;flex-shrink:0}

/* TASK SHEET EXTRA BUTTONS */
.sh-extra{display:flex;flex-direction:column;gap:8px;padding:0 18px 0}

/* SHOP */
.stabs{display:flex;gap:6px;margin-bottom:14px;background:rgba(0,0,0,.3);border-radius:12px;padding:4px}
.stab{flex:1;padding:9px;border-radius:9px;border:none;background:transparent;color:var(--muted);font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .2s}
.stab.active{background:var(--glass);color:var(--text);box-shadow:0 2px 8px rgba(0,0,0,.3)}
.sgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.sitem{padding:14px 10px 12px;text-align:center;cursor:pointer;transition:transform .1s}
.sitem:active{transform:scale(.96)}
.sico{font-size:34px;margin-bottom:7px}
.sname{font-size:12px;font-weight:600;margin-bottom:5px}
.sprice{color:var(--green);font-weight:700;font-size:12px;margin-bottom:9px}
.sbuy{width:100%;background:var(--green);color:#000;border:none;border-radius:9px;padding:8px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;transition:background .1s}
.sbuy:active{background:var(--green2)}
.sbuy:disabled{background:rgba(255,255,255,0.07);color:var(--muted);cursor:not-allowed}
.sbuy.wip{background:rgba(255,255,255,0.06);color:var(--muted2);cursor:default}

/* CASES */
.cgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.ccard{cursor:pointer;transition:transform .12s;overflow:hidden;border-radius:16px}
.ccard:active{transform:scale(.96)}
.ccimg{height:100px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;position:relative;overflow:hidden}
.ccimg-ico{width:52px;height:52px;border-radius:16px;display:flex;align-items:center;justify-content:center;position:relative;z-index:1}
.ccimg-ico svg{width:28px;height:28px;stroke-width:1.6;stroke-linecap:round;stroke-linejoin:round;fill:none}
.ccimg::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 50% 30%,rgba(255,255,255,0.06) 0%,transparent 70%)}
.ccinfo{padding:8px 10px 6px;background:var(--glass)}
.ccname{font-size:12px;font-weight:700;margin-bottom:3px}
.ccprice{color:var(--green);font-weight:700;font-size:11px;display:flex;align-items:center;gap:4px;margin-bottom:6px}
.ccprice svg{width:11px;height:11px;stroke:var(--green);fill:none;stroke-width:2}
/* Prize preview button */
.ccpreview{width:100%;background:rgba(255,255,255,0.05);border:none;border-radius:7px;padding:5px;font-size:10px;color:var(--muted2);cursor:pointer;font-family:inherit;transition:background .15s}
.ccpreview:active{background:rgba(255,255,255,0.1)}

/* PRIZES PREVIEW MODAL */
.pvmo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(8px);z-index:600;align-items:flex-end}
.pvmo.show{display:flex}
.pvbox{background:#161819;border-radius:22px 22px 0 0;width:100%;padding:0 0 calc(20px + env(safe-area-inset-bottom));border-top:1px solid rgba(255,255,255,.08);animation:shup .24s cubic-bezier(.4,0,.2,1)}
.pvhdr{display:flex;align-items:center;justify-content:space-between;padding:16px 16px 12px}
.pvtitle{font-size:16px;font-weight:800}
.pvclose{width:28px;height:28px;border-radius:50%;background:rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:15px;color:var(--muted2);border:none}
.pvgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:0 14px 14px}
.pvitem{background:rgba(255,255,255,.04);border-radius:10px;padding:10px 6px;text-align:center}
.pvico{font-size:22px;margin-bottom:4px}
.pvname{font-size:9px;color:var(--muted2);font-weight:600}
.pvval{font-size:10px;color:var(--green);font-weight:700;margin-top:2px}

/* CASE MODAL */
.cmo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.88);backdrop-filter:blur(8px);z-index:700;flex-direction:column;align-items:center;justify-content:center;padding:16px}
.cmo.show{display:flex}
.cmbox{background:#161819;border-radius:22px;width:100%;max-width:430px;overflow:hidden;border:1px solid rgba(255,255,255,.08);animation:cin .32s cubic-bezier(.34,1.5,.64,1)}
@keyframes cin{from{transform:scale(.82);opacity:0}to{transform:scale(1);opacity:1}}
.cmhdr{display:flex;align-items:center;justify-content:space-between;padding:16px 16px 12px;border-bottom:1px solid rgba(255,255,255,.06)}
.cmtitle{font-size:17px;font-weight:800}
.cmclose{width:30px;height:30px;border-radius:50%;background:rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;color:var(--muted2);border:none;font-family:inherit}
.rw{position:relative;overflow:hidden;height:108px;background:#0d0e0f}
.rw::before,.rw::after{content:'';position:absolute;top:0;bottom:0;width:60px;z-index:2;pointer-events:none}
.rw::before{left:0;background:linear-gradient(90deg,#0d0e0f,transparent)}
.rw::after{right:0;background:linear-gradient(-90deg,#0d0e0f,transparent)}
.rtrack{display:flex;gap:6px;padding:6px;will-change:transform}
.ritem{min-width:88px;height:96px;border-radius:11px;flex-shrink:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;background:#1a1c1e;border:1.5px solid rgba(255,255,255,.06);transition:border-color .3s,background .3s}
.ritem.win{border-color:var(--green)!important;background:#0d2218!important;box-shadow:0 0 16px rgba(46,204,113,.2)}
.rico{font-size:28px}
.rname{font-size:9px;color:var(--muted2);font-weight:600;text-align:center;padding:0 4px}
.rval{font-size:10px;color:var(--green);font-weight:700}
.rcline{position:absolute;top:0;bottom:0;left:50%;width:2px;background:var(--green);transform:translateX(-50%);box-shadow:0 0 12px var(--green);pointer-events:none;z-index:3}
.rca-t{position:absolute;top:0;left:50%;transform:translateX(-50%);z-index:4;border-left:7px solid transparent;border-right:7px solid transparent;border-top:9px solid var(--green);pointer-events:none}
.rca-b{position:absolute;bottom:0;left:50%;transform:translateX(-50%);z-index:4;border-left:7px solid transparent;border-right:7px solid transparent;border-bottom:9px solid var(--green);pointer-events:none}
.cmfoot{padding:14px 16px}
.cmcost{text-align:center;font-size:12px;color:var(--muted2);margin-bottom:10px}
.cmspin{width:100%;background:var(--green);color:#000;border:none;border-radius:13px;padding:14px;font-size:15px;font-weight:800;cursor:pointer;font-family:inherit;transition:all .15s}
.cmspin:active{background:var(--green2);transform:scale(.98)}
.cmspin:disabled{background:rgba(255,255,255,.07);color:var(--muted);cursor:not-allowed}
.cres{display:none;padding:24px 20px;text-align:center}
.cres.show{display:block}
.cres-ico{font-size:64px;display:block;margin-bottom:12px;animation:bounce .5s ease}
@keyframes bounce{0%,100%{transform:scale(1)}50%{transform:scale(1.16)}}
.cres-t{font-size:20px;font-weight:800;margin-bottom:5px}
.cres-s{font-size:13px;color:var(--muted2);margin-bottom:20px}
.cres-btn{width:100%;background:var(--green);color:#000;border:none;border-radius:13px;padding:13px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit}

/* RAFFLES */
.raffles-empty{display:flex;flex-direction:column;align-items:center;padding:60px 20px 40px;gap:16px}
.raffles-empty-ico{font-size:56px;opacity:.25}
.raffles-empty-t{font-size:19px;font-weight:800;color:#444}
.raffles-empty-s{font-size:13px;color:var(--muted);text-align:center;line-height:1.5}

/* FRIENDS */
.refblock{background:rgba(46,204,113,0.08);border:1px solid rgba(46,204,113,0.2);border-radius:16px;padding:16px;margin-bottom:14px;position:relative;overflow:hidden}
.refblock::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(46,204,113,0.4),transparent)}
.reflbl{font-size:10px;font-weight:700;color:var(--green);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px}
.refdesc{font-size:13px;color:var(--muted2);margin-bottom:3px}
.refamt{font-size:26px;font-weight:900;color:var(--green);margin-bottom:12px;display:flex;align-items:center;gap:7px}
.refamt svg{width:20px;height:20px;stroke:var(--green);fill:none;stroke-width:2}
.refwarn{background:var(--rdim);border:1px solid rgba(255,96,96,0.2);border-radius:11px;padding:10px 12px;margin-bottom:12px;font-size:12px;color:var(--red);line-height:1.5;font-weight:500}
.reflinkrow{background:rgba(0,0,0,.3);border:1px solid rgba(46,204,113,0.2);border-radius:11px;padding:10px 12px;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.reflinkt{flex:1;font-size:12px;color:var(--green);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-family:monospace}
.refcopy{width:34px;height:34px;background:var(--gdim);border:none;border-radius:9px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}
.refcopy svg{width:15px;height:15px;stroke:var(--green);fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
.refshare{width:100%;background:var(--green);color:#000;border:none;border-radius:13px;padding:13px;font-size:15px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .15s}
.refshare:active{background:var(--green2);transform:scale(.98)}
.refstats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px}
.rstat{padding:12px 6px;text-align:center}
.rslbl{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;font-weight:600;margin-bottom:7px;line-height:1.4}
.rsval{font-size:22px;font-weight:900}
.rsval.g{font-size:18px;color:var(--green);display:flex;align-items:center;justify-content:center;gap:3px}
.rsval.g svg{width:14px;height:14px;stroke:var(--green);fill:none;stroke-width:2}
.rssub{font-size:9px;color:var(--muted);margin-top:3px}
.rtask{padding:13px 14px;margin-bottom:14px}
.rtop{display:flex;align-items:center;justify-content:space-between;margin-bottom:5px}
.rtag{background:var(--rdim);color:var(--red);border-radius:20px;padding:3px 9px;font-size:11px;font-weight:600}
.rprize{color:var(--green);font-weight:700;font-size:13px;display:flex;align-items:center;gap:4px}
.rprize svg{width:13px;height:13px;stroke:var(--green);fill:none;stroke-width:2}
.rtitle{font-size:15px;font-weight:700;margin-bottom:5px}
.rdesc{font-size:12px;color:var(--muted2);line-height:1.5;margin-bottom:10px}
.rpb{background:rgba(255,255,255,.07);border-radius:4px;height:3px;margin-bottom:5px}
.rpbf{background:var(--green);border-radius:4px;height:100%;width:0%;transition:width .5s}
.rpr{display:flex;justify-content:flex-end;font-size:11px;color:var(--muted)}
.norefs{display:flex;flex-direction:column;align-items:center;padding:36px 20px;gap:12px}
.nrico{font-size:48px;opacity:.2}
.nrt{font-size:17px;font-weight:700;color:#333}
.nrs{font-size:12px;color:var(--muted);text-align:center}

/* PROFILE */
.profuc{padding:14px;margin-bottom:10px;display:flex;align-items:center;gap:13px}
.profav{width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--green),#1a7a40);display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700;border:2px solid rgba(46,204,113,.4);box-shadow:0 0 20px rgba(46,204,113,.2);overflow:hidden;flex-shrink:0}
.profav img{width:100%;height:100%;object-fit:cover}
.profname{font-size:19px;font-weight:800;margin-bottom:3px;background:linear-gradient(135deg,#ffffff 0%,#2ecc71 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.profun{font-size:13px;color:var(--muted2)}
.prow{padding:13px 14px;margin-bottom:8px;display:flex;align-items:center;gap:13px}
.prow-c{cursor:pointer;transition:transform .1s}
.prow-c:active{transform:scale(.98)}
.pro-ico{width:26px;text-align:center;color:var(--green);flex-shrink:0}
.pro-ico svg{width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round}
.pro-c2{flex:1}
.pro-l{font-size:11px;color:var(--muted2);margin-bottom:2px}
.pro-v{font-size:15px;font-weight:600}
.pro-arr{color:var(--muted);font-size:18px}
.pro-info{width:26px;height:26px;border-radius:50%;background:var(--gdim);display:flex;align-items:center;justify-content:center;cursor:pointer;border:none}
.pro-info svg{width:12px;height:12px;stroke:var(--green);fill:none;stroke-width:2;stroke-linecap:round}
.profpromo{padding:14px}
.profplbl{display:flex;align-items:center;gap:7px;font-size:13px;font-weight:600;color:var(--green);margin-bottom:10px}
/* VIP STATUS */
.vip-active{color:var(--green);font-weight:700}
.vip-expired{color:var(--orange);font-weight:700}
.vip-none{color:var(--red);font-weight:700}

/* COLOR PICKER MODAL */
.cpmo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(8px);z-index:600;align-items:flex-end}
.cpmo.show{display:flex}
.cpbox{background:#161819;border-radius:22px 22px 0 0;width:100%;padding:0 0 calc(20px + env(safe-area-inset-bottom));border-top:1px solid rgba(255,255,255,.08);animation:shup .24s cubic-bezier(.4,0,.2,1)}
.cphdr{display:flex;align-items:center;justify-content:space-between;padding:16px 16px 10px}
.cptitle{font-size:16px;font-weight:800}
.cpclose{width:28px;height:28px;border-radius:50%;background:rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:15px;color:var(--muted2);border:none}
.cpgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:0 14px 14px}
.cpitem{border:2px solid transparent;border-radius:12px;padding:12px 8px;text-align:center;cursor:pointer;font-size:13px;font-weight:700;transition:all .15s}
.cpitem:active{transform:scale(.96)}
.cpitem.sel{border-color:rgba(255,255,255,.3)}
.cpbuy{width:calc(100% - 28px);margin:0 14px;background:var(--green);color:#000;border:none;border-radius:13px;padding:13px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit}
.cpbuy:active{background:var(--green2)}

/* BOTTOM SHEET */
.shov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(4px);z-index:400;align-items:flex-end}
.shov.show{display:flex}
.sh{background:#161819;border-radius:22px 22px 0 0;width:100%;padding:0 0 calc(22px + env(safe-area-inset-bottom));border-top:1px solid rgba(255,255,255,.07);animation:shup .24s cubic-bezier(.4,0,.2,1)}
@keyframes shup{from{transform:translateY(100%)}to{transform:translateY(0)}}
.sh-h{width:36px;height:4px;background:rgba(255,255,255,.12);border-radius:4px;margin:12px auto 18px}
.sh-t{font-size:17px;font-weight:800;padding:0 18px;margin-bottom:5px}
.sh-s{font-size:12px;color:var(--muted2);padding:0 18px;margin-bottom:14px}
.sh-a{width:calc(100% - 36px);margin:0 18px;background:var(--green);color:#000;border:none;border-radius:13px;padding:13px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit}
.sh-b{width:calc(100% - 36px);margin:8px 18px 0;background:rgba(255,255,255,.08);color:var(--text);border:none;border-radius:13px;padding:13px;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit}
.sh-c{width:calc(100% - 36px);margin:8px 18px 0;background:rgba(255,255,255,.04);color:var(--muted2);border:none;border-radius:13px;padding:13px;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit}
</style>
</head>
<body>

<div class="toast green" id="toast"></div>

<!-- BOTTOM SHEET -->
<div class="shov" id="sheet" onclick="closeSheet(event)">
  <div class="sh">
    <div class="sh-h"></div>
    <div class="sh-t" id="sh-t"></div>
    <div class="sh-s" id="sh-s"></div>
    <div id="sh-extra"></div>
    <button class="sh-a" id="sh-a" onclick="doSheet()"></button>
    <button class="sh-c" onclick="closeSheet()">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<!-- PRIZES PREVIEW MODAL -->
<div class="pvmo" id="pvmo" onclick="closePV(event)">
  <div class="pvbox">
    <div class="pvhdr">
      <div class="pvtitle" id="pv-t">–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏–∑—ã</div>
      <button class="pvclose" onclick="closePV()">‚úï</button>
    </div>
    <div class="pvgrid" id="pv-grid"></div>
  </div>
</div>

<!-- COLOR PICKER MODAL -->
<div class="cpmo" id="cpmo" onclick="closeCP(event)">
  <div class="cpbox">
    <div class="cphdr">
      <div class="cptitle">üåà –í—ã–±–µ—Ä–∏ —Ü–≤–µ—Ç –Ω–∏–∫–∞</div>
      <button class="cpclose" onclick="closeCP()">‚úï</button>
    </div>
    <div class="cpgrid" id="cp-grid"></div>
    <button class="cpbuy" onclick="buyColorNick()">–ö—É–ø–∏—Ç—å ‚Äî 250 ü™ô</button>
  </div>
</div>

<!-- CASE MODAL -->
<div class="cmo" id="cmo">
  <div class="cmbox">
    <div class="cmhdr">
      <div class="cmtitle" id="cm-t">–ö–µ–π—Å</div>
      <button class="cmclose" onclick="closeCase()">‚úï</button>
    </div>
    <div id="cm-spin">
      <div class="rw">
        <div class="rtrack" id="rtrack"></div>
        <div class="rcline"></div>
        <div class="rca-t"></div>
        <div class="rca-b"></div>
      </div>
      <div class="cmfoot">
        <div class="cmcost" id="cm-cost"></div>
        <button class="cmspin" id="cm-btn" onclick="spinCase()">üé∞ –û—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å</button>
      </div>
    </div>
    <div class="cres" id="cres">
      <span class="cres-ico" id="cr-ico">üéÅ</span>
      <div class="cres-t" id="cr-t">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</div>
      <div class="cres-s" id="cr-s">–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏</div>
      <button class="cres-btn" onclick="closeCase()">–ó–∞–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É</button>
    </div>
  </div>
</div>

<div class="app">
<div class="pages">

<!-- HOME -->
<div class="page active" id="page-home">
  <div class="hhdr">
    <div class="huser">
      <div class="av" id="av-h">?</div>
      <div>
        <div class="welcome">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å,</div>
        <div class="username-grad" id="h-name-wrap"><span id="h-name">User</span></div>
      </div>
    </div>
    <div class="bpill">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
      <span id="b-home">0</span>
    </div>
  </div>
  <div class="mgrid">
    <div class="mc" onclick="go('tasks')">
      <div class="mc-ico"><svg viewBox="0 0 24 24"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg></div>
      <div class="mc-t">–ó–∞–¥–∞–Ω–∏—è</div><div class="mc-s">–í—ã–ø–æ–ª–Ω—è–π –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π</div>
    </div>
    <div class="mc" onclick="go('shop')">
      <div class="mc-ico"><svg viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 001.98 1.61h9.72a2 2 0 001.98-1.61L23 6H6"/></svg></div>
      <div class="mc-t">–ú–∞–≥–∞–∑–∏–Ω</div><div class="mc-s">–¢—Ä–∞—Ç—å –º–æ–Ω–µ—Ç—ã</div>
    </div>
    <div class="mc" onclick="go('raffles')">
      <div class="mc-ico"><svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/><line x1="12" y1="12" x2="12" y2="16"/><line x1="10" y1="14" x2="14" y2="14"/></svg></div>
      <div class="mc-t">–†–æ–∑—ã–≥—Ä—ã—à–∏</div><div class="mc-s">–ò—Å–ø—ã—Ç–∞–π —É–¥–∞—á—É</div>
    </div>
    <div class="mc" onclick="go('friends')">
      <div class="mc-ico"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg></div>
      <div class="mc-t">–†–µ—Ñ–µ—Ä–∞–ª—ã</div><div class="mc-s">–ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π</div>
    </div>
  </div>
  <div class="gc pcard">
    <div class="plbl"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>–ü—Ä–æ–º–æ–∫–æ–¥</div>
    <div class="prow"><input class="pin" id="pi-h" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" type="text" autocapitalize="characters"><button class="pbtn" onclick="usePromo('pi-h')">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button></div>
  </div>
  <div class="rahdr">
    <div class="sec" style="margin-bottom:0">–ê–∫—Ç–∏–≤–Ω—ã–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∏</div>
    <button class="seeall" onclick="go('raffles')">–í—Å–µ</button>
  </div>
  <div id="h-raf" style="margin-top:10px;display:flex;align-items:center;gap:10px;overflow-x:auto;padding-bottom:4px">
    <div style="display:flex;flex-direction:column;align-items:center;gap:10px;padding:30px 20px;width:100%;opacity:.3">
      <div style="font-size:32px">üéÅ</div>
      <div style="font-size:13px;color:var(--muted)">–†–æ–∑—ã–≥—Ä—ã—à–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</div>
    </div>
  </div>
</div>

<!-- TASKS -->
<div class="page" id="page-tasks">
  <div class="phdr">
    <div class="ptitle">–ó–∞–¥–∞–Ω–∏—è</div>
    <div class="bpill"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg><span id="b-tasks">0</span></div>
  </div>
  <div id="tasks-list"></div>
</div>

<!-- SHOP -->
<div class="page" id="page-shop">
  <div class="phdr">
    <div class="ptitle">–ú–∞–≥–∞–∑–∏–Ω</div>
    <div class="bpill"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg><span id="b-shop">0</span></div>
  </div>
  <div class="stabs">
    <button class="stab active" onclick="shopTab('items',this)">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
    <button class="stab" onclick="shopTab('cases',this)">üì¶ –ö–µ–π—Å—ã</button>
  </div>
  <div class="sgrid" id="shop-items"></div>
  <div class="cgrid" id="shop-cases" style="display:none"></div>
</div>

<!-- RAFFLES -->
<div class="page" id="page-raffles">
  <div class="phdr">
    <div class="ptitle">–†–æ–∑—ã–≥—Ä—ã—à–∏</div>
    <div class="bpill"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg><span id="b-raffles">0</span></div>
  </div>
  <div class="raffles-empty">
    <div class="raffles-empty-ico">üéÅ</div>
    <div class="raffles-empty-t">–ü–æ–∫–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –Ω–µ—Ç</div>
    <div class="raffles-empty-s">–°–∫–æ—Ä–æ –∑–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –ø—Ä–∏–∑—ã ‚Äî<br>—Å–ª–µ–¥–∏ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏!</div>
  </div>
</div>

<!-- FRIENDS -->
<div class="page" id="page-friends">
  <div class="phdr">
    <div class="ptitle">–†–µ—Ñ–µ—Ä–∞–ª—ã</div>
    <div class="bpill"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg><span id="b-friends">0</span></div>
  </div>
  <div class="refblock">
    <div class="reflbl">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞</div>
    <div class="refdesc">–ó–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ</div>
    <div class="refamt"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>1 000</div>
    <div class="refwarn">‚ö†Ô∏è –£ —Ä–µ—Ñ–µ—Ä–∞–ª–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å @username –≤ Telegram, –∏–Ω–∞—á–µ –æ–Ω –Ω–µ –∑–∞—Å—á–∏—Ç–∞–µ—Ç—Å—è.</div>
    <div class="reflinkrow">
      <div class="reflinkt" id="ref-link">https://t.me/bot?start=...</div>
      <button class="refcopy" onclick="copyRef()"><svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg></button>
    </div>
    <button class="refshare" onclick="shareRef()">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –≤ Telegram</button>
  </div>
  <div class="refstats">
    <div class="rstat gc"><div class="rslbl">–õ–∏—á–Ω–æ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–µ</div><div class="rsval" id="ref-count1">0</div><div class="rssub">1% —Å –∏—Ö –Ω–∞–≥—Ä–∞–¥</div></div>
    <div class="rstat gc"><div class="rslbl">–ü—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–µ –¥—Ä—É–∑—å—è–º–∏</div><div class="rsval" id="ref-count2">0</div><div class="rssub">0.1% —Å –Ω–∞–≥—Ä–∞–¥</div></div>
    <div class="rstat gc"><div class="rslbl">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div><div class="rsval g" id="ref-earned"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>0</div></div>
  </div>
  <div class="rtask gc">
    <div class="rtop"><div class="rtag">–î—Ä—É–∑—å—è</div><div class="rprize"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>2 000</div></div>
    <div class="rtitle">–ü—Ä–∏–≥–ª–∞—Å–∏ 3 –¥—Ä—É–∑–µ–π (+1000 –∑–∞ –∫–∞–∂–¥–æ–≥–æ!)</div>
    <div class="rdesc">–ü—Ä–∏–≥–ª–∞—à–∞–π –ø–æ —Å–≤–æ–µ–π —Ä–µ—Ñ-—Å—Å—ã–ª–∫–µ –∏ –ø–æ–ª—É—á–∏ +1000 –∑–∞ –∫–∞–∂–¥–æ–≥–æ + –±–æ–Ω—É—Å 2000!</div>
    <div class="rpb"><div class="rpbf" id="ref-prog-bar"></div></div>
    <div class="rpr" id="ref-prog-txt">0 / 3</div>
  </div>
  <div class="sec">–í–∞—à–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—ã</div>
  <div id="ref-list"></div>
</div>

<!-- PROFILE -->
<div class="page" id="page-profile">
  <div class="phdr">
    <div class="ptitle">–ü—Ä–æ—Ñ–∏–ª—å</div>
    <div class="bpill"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg><span id="b-profile">0</span></div>
  </div>
  <div class="gc profuc">
    <div class="profav" id="av-p">?</div>
    <div><div class="profname" id="p-name">User</div><div class="profun" id="p-un">@username</div></div>
  </div>
  <div class="gc prow">
    <div class="pro-ico"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg></div>
    <div class="pro-c2"><div class="pro-l">–ë–∞–ª–∞–Ω—Å</div><div class="pro-v" id="p-bal">0</div></div>
    <button class="pro-info" onclick="showToast('üí° –ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π, –≤—ã–ø–æ–ª–Ω—è—è –∑–∞–¥–∞–Ω–∏—è!','green')"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg></button>
  </div>
  <div class="gc prow prow-c" onclick="go('friends')">
    <div class="pro-ico"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg></div>
    <div class="pro-c2"><div class="pro-l">–†–µ—Ñ–µ—Ä–∞–ª–æ–≤</div><div class="pro-v" id="p-refs">0</div></div>
    <span class="pro-arr">‚Ä∫</span>
  </div>
  <!-- VIP —Å—Ç–∞—Ç—É—Å -->
  <div class="gc prow">
    <div class="pro-ico"><svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></div>
    <div class="pro-c2"><div class="pro-l">VIP —Å—Ç–∞—Ç—É—Å</div><div class="pro-v" id="p-vip">‚Äî</div></div>
  </div>
  <!-- –¶–≤–µ—Ç –Ω–∏–∫–∞ -->
  <div class="gc prow">
    <div class="pro-ico"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg></div>
    <div class="pro-c2"><div class="pro-l">–¶–≤–µ—Ç –Ω–∏–∫–∞</div><div class="pro-v" id="p-color">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π</div></div>
  </div>
  <div class="gc prow">
    <div class="pro-ico"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div>
    <div class="pro-c2"><div class="pro-l">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</div><div class="pro-v" id="p-reg">‚Äî</div></div>
  </div>
  <div class="gc profpromo">
    <div class="profplbl"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>–ü—Ä–æ–º–æ–∫–æ–¥</div>
    <div class="prow" style="background:transparent;border:none;padding:0;margin:0">
      <input class="pin" id="pi-p" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" type="text" autocapitalize="characters">
      <button class="pbtn" onclick="usePromo('pi-p')">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

</div><!-- /pages -->

<nav class="nav">
  <button class="nb active" id="nb-home" onclick="go('home')"><div class="nb-bg"></div><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><span>–ì–ª–∞–≤–Ω–∞—è</span></button>
  <button class="nb" id="nb-tasks" onclick="go('tasks')"><div class="nb-bg"></div><svg viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg><span>–ó–∞–¥–∞–Ω–∏—è</span></button>
  <button class="nb" id="nb-shop" onclick="go('shop')"><div class="nb-bg"></div><svg viewBox="0 0 24 24"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg><span>–ú–∞–≥–∞–∑–∏–Ω</span></button>
  <button class="nb" id="nb-friends" onclick="go('friends')"><div class="nb-bg"></div><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg><span>–î—Ä—É–∑—å—è</span></button>
  <button class="nb" id="nb-profile" onclick="go('profile')"><div class="nb-bg"></div><svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg><span>–ü—Ä–æ—Ñ–∏–ª—å</span></button>
</nav>
</div>

<script>
/* ‚îÄ‚îÄ‚îÄ TELEGRAM ‚îÄ‚îÄ‚îÄ */
const tg = window.Telegram?.WebApp;
if(tg){tg.ready();tg.expand();try{tg.setHeaderColor('#0a0a0a');tg.setBackgroundColor('#0a0a0a');}catch(e){}}
let TGUser = tg?.initDataUnsafe?.user || {id:123456,first_name:'ik',username:'assate',photo_url:null};
const UID = String(TGUser.id);

/* ‚îÄ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ‚îÄ */
const SK = 'gb3_'+UID;
function load(){try{const d=JSON.parse(localStorage.getItem(SK)||'{}');return d.v===4?d:null;}catch{return null;}}
function save(){
  try{localStorage.setItem(SK,JSON.stringify({
    v:4,balance:S.balance,doneTasks:[...S.doneTasks],
    usedPromos:[...S.usedPromos],regDate:S.regDate,
    refs:S.refs,refEarned:S.refEarned,refBy:S.refBy,
    vipExpiry:S.vipExpiry,nickColor:S.nickColor,
    task3refsDone:S.task3refsDone,
  }));}catch{}
}

const saved = load();
const today = new Date().toLocaleDateString('ru-RU',{day:'numeric',month:'long',year:'numeric'});

const S = {
  balance: saved?.balance ?? 1000,
  doneTasks: new Set(saved?.doneTasks||[]),
  usedPromos: new Set(saved?.usedPromos||[]),
  regDate: saved?.regDate || today,
  refs: saved?.refs || [],
  refEarned: saved?.refEarned || 0,
  refBy: saved?.refBy || null,
  vipExpiry: saved?.vipExpiry || null,   // timestamp ms
  nickColor: saved?.nickColor || '',     // '' = default
  task3refsDone: saved?.task3refsDone || false,
};

/* ‚îÄ‚îÄ‚îÄ REF PARAM ‚îÄ‚îÄ‚îÄ */
(function(){
  try{
    const sp = tg?.initDataUnsafe?.start_param || '';
    if(!sp.startsWith('ref_')) return;
    const refUID = sp.replace('ref_','');
    if(refUID===UID||S.refBy) return;
    S.refBy = refUID;
    // Credit inviter
    const rk='gb3_'+refUID;
    const rd=JSON.parse(localStorage.getItem(rk)||'{}');
    if(!rd.refs) rd.refs=[];
    const uname=TGUser.username?'@'+TGUser.username:TGUser.first_name;
    rd.refs.push({name:uname,date:today});
    rd.balance=(rd.balance||1000)+1000;
    rd.refEarned=(rd.refEarned||0)+1000;
    if(rd.refs.length>=3&&!rd.task3refsDone){rd.balance+=2000;rd.task3refsDone=true;}
    rd.v=4;
    localStorage.setItem(rk,JSON.stringify(rd));
    save();
  }catch{}
})();

/* ‚îÄ‚îÄ‚îÄ DATA ‚îÄ‚îÄ‚îÄ */
const TASKS=[
  {id:1,ico:'üì¢',tag:'–ö–∞–Ω–∞–ª',  tc:'r',name:'–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª', desc:'–ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ @broketalking',   rew:100, url:'https://t.me/broketalking', checkType:'sub',  channel:'broketalking'},
  {id:2,ico:'üí¨',tag:'–ó–∞–¥–∞–Ω–∏–µ',tc:'r',name:'–ù–∞–ø–∏—Å–∞—Ç—å –≤ —á–∞—Ç',        desc:'–ù–∞–ø–∏—à–∏ –ª—é–±–æ–µ —Å–ª–æ–≤–æ –≤ —á–∞—Ç–µ',   rew:50,  url:'https://t.me/drainself',    checkType:'chat', channel:'drainself'},
  {id:4,ico:'üë•',tag:'–î—Ä—É–∑—å—è', tc:'g',name:'–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –ø–µ—Ä–≤–æ–≥–æ –¥—Ä—É–≥–∞',desc:'–ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞ –ø–æ —Ä–µ—Ñ-—Å—Å—ã–ª–∫–µ',rew:1000,checkType:'ref'},
  {id:6,ico:'üì¶',tag:'–ó–∞–¥–∞–Ω–∏–µ',tc:'r',name:'–û—Ç–∫—Ä—ã—Ç—å –ø–µ—Ä–≤—ã–π –∫–µ–π—Å',   desc:'–û—Ç–∫—Ä–æ–π –ª—é–±–æ–π –∫–µ–π—Å –≤ –ú–∞–≥–∞–∑–∏–Ω–µ',rew:200, checkType:'case'},
];

const ITEMS=[
  {id:2,ico:'üíé',name:'–ö—Ä–∏—Å—Ç–∞–ª–ª —É–¥–∞—á–∏',  price:300, wip:false},
  {id:3,ico:'üèÜ',name:'VIP –Ω–∞ 7 –¥–Ω–µ–π',   price:500, wip:false},
  {id:4,ico:'üé∞',name:'–î–æ–ø. –ø–æ–ø—ã—Ç–∫–∞',    price:200, wip:true},
  {id:5,ico:'üåà',name:'–¶–≤–µ—Ç–Ω–æ–π –Ω–∏–∫',     price:250, wip:false, special:'color'},
  {id:6,ico:'‚ú®',name:'–ë—É—Å—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤',  price:400, wip:false},
];

const NICK_COLORS=[
  {id:'grad-purple', label:'–§–∏–æ–ª–µ—Ç–æ–≤—ã–π', preview:'linear-gradient(135deg,#bf5af2,#da8fff)', textColor:'#bf5af2'},
  {id:'grad-gold',   label:'–ó–æ–ª–æ—Ç–æ–π',    preview:'linear-gradient(135deg,#f4c430,#f39c12)', textColor:'#f4c430'},
  {id:'grad-red',    label:'–ö—Ä–∞—Å–Ω—ã–π',    preview:'linear-gradient(135deg,#ff6060,#ff4444)', textColor:'#ff6060'},
  {id:'grad-blue',   label:'–°–∏–Ω–∏–π',      preview:'linear-gradient(135deg,#5b8def,#3a5bbe)', textColor:'#5b8def'},
  {id:'grad-pink',   label:'–†–æ–∑–æ–≤—ã–π',    preview:'linear-gradient(135deg,#ff6fb7,#ff4499)', textColor:'#ff6fb7'},
  {id:'',            label:'–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π',preview:'linear-gradient(135deg,#ffffff,#2ecc71)', textColor:'#2ecc71'},
];

const CASES=[
  {id:1,name:'–°—Ç–∞—Ä—Ç–æ–≤—ã–π',price:50,bg:'linear-gradient(145deg,#0d1f14,#122010)',iconColor:'#2ecc71',iconBg:'rgba(46,204,113,.15)',
   icon:`<svg viewBox="0 0 24 24" stroke="#2ecc71"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>`,
   drops:[{i:'ü™ô',n:'–ú–æ–Ω–µ—Ç—ã',v:'+50'},{i:'üéÅ',n:'–ü–æ–¥–∞—Ä–æ–∫',v:'x1'},{i:'‚≠ê',n:'–ë–æ–Ω—É—Å',v:'+20'},{i:'üíé',n:'–ö—Ä–∏—Å—Ç–∞–ª–ª',v:'x1'},{i:'ü™ô',n:'–ú–æ–Ω–µ—Ç—ã',v:'+100'},{i:'üéüÔ∏è',n:'–ë–∏–ª–µ—Ç',v:'x1'},{i:'üèÜ',n:'VIP',v:'1 –¥–µ–Ω—å',vipDays:1},{i:'ü™ô',n:'–ú–æ–Ω–µ—Ç—ã',v:'+30'}]},
  {id:2,name:'–û–±—ã—á–Ω—ã–π',price:150,bg:'linear-gradient(145deg,#0d1428,#101828)',iconColor:'#5B8DEF',iconBg:'rgba(91,141,239,.15)',
   icon:`<svg viewBox="0 0 24 24" stroke="#5B8DEF"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/><line x1="12" y1="12" x2="12" y2="16"/><line x1="10" y1="14" x2="14" y2="14"/></svg>`,
   drops:[{i:'üí∞',n:'–ú–æ–Ω–µ—Ç—ã',v:'+200'},{i:'üéÅ',n:'–ü–æ–¥–∞—Ä–æ–∫',v:'x2'},{i:'üíé',n:'–ö—Ä–∏—Å—Ç–∞–ª–ª',v:'x2'},{i:'üèÜ',n:'VIP',v:'3 –¥–Ω—è',vipDays:3},{i:'‚≠ê',n:'–ë–æ–Ω—É—Å',v:'+100'},{i:'üéüÔ∏è',n:'–ë–∏–ª–µ—Ç',v:'x3'},{i:'üí∞',n:'–ú–æ–Ω–µ—Ç—ã',v:'+150'},{i:'üåü',n:'–°—É–ø–µ—Ä',v:'x1'}]},
  {id:3,name:'–ó–æ–ª–æ—Ç–æ–π',price:500,bg:'linear-gradient(145deg,#1a1500,#1e1800)',iconColor:'#F4C430',iconBg:'rgba(244,196,48,.15)',
   icon:`<svg viewBox="0 0 24 24" stroke="#F4C430"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`,
   drops:[{i:'üí∞',n:'–ú–æ–Ω–µ—Ç—ã',v:'+1000'},{i:'üèÜ',n:'VIP',v:'7 –¥–Ω–µ–π',vipDays:7},{i:'üíé',n:'–ö—Ä–∏—Å—Ç–∞–ª–ª',v:'x5'},{i:'üéÅ',n:'–ü–æ–¥–∞—Ä–æ–∫',v:'x5'},{i:'üåü',n:'–°—É–ø–µ—Ä',v:'x3'},{i:'üëë',n:'–ö–æ—Ä–æ–Ω–∞',v:'x1'},{i:'üí∞',n:'–ú–æ–Ω–µ—Ç—ã',v:'+2000'},{i:'üèÜ',n:'VIP',v:'3 –¥–Ω—è',vipDays:3}]},
  {id:4,name:'–ü—Ä–µ–º–∏—É–º',price:1000,bg:'linear-gradient(145deg,#200a0a,#1a0808)',iconColor:'#FF4D4D',iconBg:'rgba(255,77,77,.15)',
   icon:`<svg viewBox="0 0 24 24" stroke="#FF4D4D"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/><circle cx="12" cy="12" r="3"/></svg>`,
   drops:[{i:'üëë',n:'–ö–æ—Ä–æ–Ω–∞',v:'x1'},{i:'üí∞',n:'–ú–æ–Ω–µ—Ç—ã',v:'+5000'},{i:'üèÜ',n:'VIP',v:'30 –¥–Ω–µ–π',vipDays:30},{i:'üíé',n:'–ö—Ä–∏—Å—Ç–∞–ª–ª',v:'x10'},{i:'üåü',n:'–õ–µ–≥–µ–Ω–¥–∞',v:'x1'},{i:'üèÜ',n:'VIP',v:'7 –¥–Ω–µ–π',vipDays:7},{i:'üí∞',n:'–ú–æ–Ω–µ—Ç—ã',v:'+10000'},{i:'üéÅ',n:'–ú–µ–≥–∞-–ø–æ–¥–∞—Ä–æ–∫',v:'x1'}]},
];

const PROMOS={
  'GIFT100':{reward:100},'BONUS50':{reward:50},'START200':{reward:200},
  'WELCOME':{reward:75},'VIP500':{reward:500},'NEW1000':{reward:1000},
};

/* ‚îÄ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ */
const PAGES=['home','tasks','shop','friends','profile','raffles'];
let curPage='home',navLocked=false;

function go(name){
  if(name===curPage||navLocked)return;
  navLocked=true;
  const old=document.getElementById('page-'+curPage);
  const nw=document.getElementById('page-'+name);
  old.classList.add('exit');
  old.addEventListener('animationend',()=>{old.classList.remove('active','exit');old.style.display='none';},{once:true});
  setTimeout(()=>{nw.style.display='block';nw.classList.add('active');nw.addEventListener('animationend',()=>{navLocked=false;},{once:true});},80);
  PAGES.forEach(p=>{document.getElementById('nb-'+p)?.classList.remove('active');});
  document.getElementById('nb-'+name)?.classList.add('active');
  curPage=name;syncB();
}

/* ‚îÄ‚îÄ‚îÄ BALANCE ‚îÄ‚îÄ‚îÄ */
function syncB(){
  const b=S.balance.toLocaleString('ru');
  ['home','tasks','shop','raffles','friends','profile'].forEach(k=>{const el=document.getElementById('b-'+k);if(el)el.textContent=b;});
  const pb=document.getElementById('p-bal');if(pb)pb.textContent=S.balance.toLocaleString('ru');
  save();
}

/* ‚îÄ‚îÄ‚îÄ VIP ‚îÄ‚îÄ‚îÄ */
function getVipStatus(){
  if(!S.vipExpiry) return 'none';
  const now=Date.now();
  if(now<S.vipExpiry) return 'active';
  return 'expired';
}
function activateVip(days){
  const now=Date.now();
  const cur=S.vipExpiry&&S.vipExpiry>now?S.vipExpiry:now;
  S.vipExpiry=cur+days*24*60*60*1000;
  save();updateVipUI();
}
function updateVipUI(){
  const el=document.getElementById('p-vip');if(!el)return;
  const st=getVipStatus();
  if(st==='active'){
    const d=Math.ceil((S.vipExpiry-Date.now())/86400000);
    el.innerHTML=`<span class="vip-active">‚úÖ VIP –∞–∫—Ç–∏–≤–µ–Ω (${d} –¥–Ω.)</span>`;
  } else if(st==='expired'){
    el.innerHTML=`<span class="vip-expired">‚ö†Ô∏è VIP —Å—Ç–∞—Ç—É—Å –∏—Å—Ç—ë–∫</span>`;
  } else {
    el.innerHTML=`<span class="vip-none">‚ùå VIP —Å—Ç–∞—Ç—É—Å–∞ –Ω–µ—Ç</span>`;
  }
}

/* ‚îÄ‚îÄ‚îÄ NICK COLOR ‚îÄ‚îÄ‚îÄ */
function applyNickColor(colorId){
  S.nickColor=colorId;save();
  // Apply to home username
  const wrap=document.getElementById('h-name-wrap');
  if(wrap){
    wrap.className='username-grad';
    if(colorId) wrap.classList.add(colorId);
  }
  // Update profile field
  const cel=document.getElementById('p-color');
  if(cel){
    const c=NICK_COLORS.find(x=>x.id===colorId);
    cel.textContent=c?c.label:'–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π';
  }
}

/* ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ */
function init(){
  const u=TGUser;
  const name=u.first_name||'User';
  const uname=u.username?'@'+u.username:'–ë–µ–∑ username';
  function setAv(id){
    const el=document.getElementById(id);if(!el)return;
    if(u.photo_url){el.innerHTML=`<img src="${u.photo_url}" onerror="this.parentElement.textContent='${name[0].toUpperCase()}'">`;
    }else{el.textContent=name[0].toUpperCase();}
  }
  setAv('av-h');setAv('av-p');
  document.getElementById('h-name').textContent=name;
  document.getElementById('p-name').textContent=name;
  document.getElementById('p-un').textContent=uname;
  document.getElementById('p-reg').textContent=S.regDate;
  document.getElementById('p-refs').textContent=S.refs.length;
  const botName=tg?.initDataUnsafe?.bot?.username||'SATapp_bot';
  document.getElementById('ref-link').textContent=`https://t.me/${botName}?start=ref_${UID}`;
  applyNickColor(S.nickColor);
  updateVipUI();
  syncB();rTasks();rShopItems();rCases();rRefStats();rRefList();
  document.getElementById('pi-h').addEventListener('keydown',e=>{if(e.key==='Enter')usePromo('pi-h');});
  document.getElementById('pi-p').addEventListener('keydown',e=>{if(e.key==='Enter')usePromo('pi-p');});
}

/* ‚îÄ‚îÄ‚îÄ TASKS ‚îÄ‚îÄ‚îÄ */
function rTasks(){
  document.getElementById('tasks-list').innerHTML=TASKS.map(t=>{
    const done=S.doneTasks.has(t.id);
    return`<div class="gc ti" onclick="${done?'':'openTask('+t.id+')'}">
      <div class="tico">${t.ico}</div>
      <div class="tinf">
        <div class="ttag ${t.tc}">${t.tag}</div>
        <div class="tname">${t.name}</div>
        <div class="tdesc">${t.desc}</div>
      </div>
      ${done?'<div class="tdone">‚úì –ì–æ—Ç–æ–≤–æ</div>':`<div class="trew">+${t.rew} ü™ô</div>`}
    </div>`;
  }).join('');
}

// Tasks with check logic
function openTask(id){
  const t=TASKS.find(x=>x.id===id);
  if(!t||S.doneTasks.has(id))return;
  if(t.checkType==='ref'){
    if(S.refs.length>0){completeTask(id);}
    else{openSheet('–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞',`–ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞ –ø–æ —Ä–µ—Ñ-—Å—Å—ã–ª–∫–µ –∏ –ø–æ–ª—É—á–∏ +${t.rew} –º–æ–Ω–µ—Ç`,'üë• –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º',()=>{closeSheet();go('friends');});}
    return;
  }
  if(t.checkType==='case'){
    openSheet('–û—Ç–∫—Ä—ã—Ç—å –ø–µ—Ä–≤—ã–π –∫–µ–π—Å',`–û—Ç–∫—Ä–æ–π –ª—é–±–æ–π –∫–µ–π—Å –≤ –ú–∞–≥–∞–∑–∏–Ω–µ –∏ –ø–æ–ª—É—á–∏ +${t.rew} –º–æ–Ω–µ—Ç`,'üì¶ –ü–µ—Ä–µ–π—Ç–∏ –≤ –ú–∞–≥–∞–∑–∏–Ω',()=>{closeSheet();go('shop');setTimeout(()=>{document.querySelectorAll('.stab')[1]?.click();},300);});
    return;
  }
  if(t.checkType==='sub'){
    // Channel subscription task
    openTaskSheet(t,
      `–ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª @${t.channel} –∏ –≤–µ—Ä–Ω–∏—Å—å —Å—é–¥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏`,
      'üì¢ –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –∫–∞–Ω–∞–ª',
      ()=>{if(tg){tg.openTelegramLink(t.url);}else{window.open(t.url,'_blank');}closeSheet();
        setTimeout(()=>openVerifySheet(t,'–í—ã –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª?','–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É',
          ()=>{completeTask(t.id);},
          ()=>{showToast('–í—ã –Ω–µ –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å','red');}
        ),800);
      }
    );
    return;
  }
  if(t.checkType==='chat'){
    openTaskSheet(t,
      `–ù–∞–ø–∏—à–∏ –ª—é–±–æ–µ —Å–ª–æ–≤–æ –≤ —á–∞—Ç–µ @${t.channel} –∏ –≤–µ—Ä–Ω–∏—Å—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏`,
      'üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –≤ —á–∞—Ç',
      ()=>{if(tg){tg.openTelegramLink(t.url);}else{window.open(t.url,'_blank');}closeSheet();
        setTimeout(()=>openVerifySheet(t,'–í—ã –Ω–∞–ø–∏—Å–∞–ª–∏ –≤ —á–∞—Ç–µ?','–ü—Ä–æ–≤–µ—Ä–∏—Ç—å',
          ()=>{completeTask(t.id);},
          ()=>{showToast('–í—ã –Ω–µ –Ω–∞–ø–∏—Å–∞–ª–∏ –≤ —á–∞—Ç','red');}
        ),800);
      }
    );
    return;
  }
}

function openTaskSheet(t,desc,actionLabel,cb){
  openSheet(t.name,desc,actionLabel,cb);
}

function openVerifySheet(t,question,btnLabel,onYes,onNo){
  document.getElementById('sh-t').textContent=question;
  document.getElementById('sh-s').textContent=`–ó–∞–¥–∞–Ω–∏–µ: ${t.name}`;
  document.getElementById('sh-extra').innerHTML='';
  const a=document.getElementById('sh-a');
  a.textContent=btnLabel;
  _scb=onYes;
  // Add "No" button
  const nb=document.getElementById('sh-c');
  nb.textContent='–ù–µ –≤—ã–ø–æ–ª–Ω–∏–ª';
  nb.onclick=()=>{closeSheet();if(onNo)onNo();};
  document.getElementById('sheet').classList.add('show');
}

function completeTask(id){
  S.doneTasks.add(id);
  const t=TASKS.find(x=>x.id===id);
  if(t){S.balance+=t.rew;syncB();}
  closeSheet();rTasks();
  showToast(`+${t?.rew||0} –º–æ–Ω–µ—Ç! üéâ`,'green');
}

/* ‚îÄ‚îÄ‚îÄ SHOP ‚îÄ‚îÄ‚îÄ */
function shopTab(tab,btn){
  document.querySelectorAll('.stab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('shop-items').style.display=tab==='items'?'grid':'none';
  document.getElementById('shop-cases').style.display=tab==='cases'?'grid':'none';
}

function rShopItems(){
  document.getElementById('shop-items').innerHTML=ITEMS.map(x=>{
    const ok=S.balance>=x.price;
    let btn;
    if(x.wip){btn=`<button class="sbuy wip" disabled>–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</button>`;}
    else if(x.special==='color'){btn=`<button class="sbuy" onclick="openColorPicker()" ${ok?'':''}>–í—ã–±—Ä–∞—Ç—å —Ü–≤–µ—Ç</button>`;}
    else{btn=`<button class="sbuy"${ok?'':' disabled'} onclick="buyItem(${x.id})">${ok?'–ö—É–ø–∏—Ç—å':'–ú–∞–ª–æ –º–æ–Ω–µ—Ç'}</button>`;}
    return`<div class="gc sitem">
      <div class="sico">${x.ico}</div>
      <div class="sname">${x.name}</div>
      <div class="sprice">${x.price} ü™ô</div>
      ${btn}
    </div>`;
  }).join('');
}

function buyItem(id){
  const x=ITEMS.find(i=>i.id===id);
  if(!x||S.balance<x.price)return;
  openSheet(`–ö—É–ø–∏—Ç—å ${x.name}?`,`–°–ø–∏—à–µ—Ç—Å—è ${x.price} –º–æ–Ω–µ—Ç`,`üõí –ö—É–ø–∏—Ç—å ‚Äî ${x.price} ü™ô`,()=>{
    S.balance-=x.price;
    // VIP logic
    if(id===3){activateVip(7);showToast('üèÜ VIP –Ω–∞ 7 –¥–Ω–µ–π –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!','green');}
    syncB();rShopItems();closeSheet();
    if(id!==3)showToast(`${x.ico} –ö—É–ø–ª–µ–Ω–æ!`,'green');
  });
}

/* ‚îÄ‚îÄ‚îÄ COLOR PICKER ‚îÄ‚îÄ‚îÄ */
let selectedColor='';
function openColorPicker(){
  selectedColor=S.nickColor;
  document.getElementById('cp-grid').innerHTML=NICK_COLORS.map(c=>`
    <div class="cpitem${S.nickColor===c.id?' sel':''}" 
         style="background:${c.preview};color:#000"
         onclick="selectColor('${c.id}',this)">
      ${c.label}
    </div>`).join('');
  document.getElementById('cpmo').classList.add('show');
}
function selectColor(id,el){
  selectedColor=id;
  document.querySelectorAll('.cpitem').forEach(e=>e.classList.remove('sel'));
  el.classList.add('sel');
}
function buyColorNick(){
  if(S.balance<250){showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç','red');return;}
  S.balance-=250;
  applyNickColor(selectedColor);
  syncB();rShopItems();
  closeCP();
  showToast('üåà –¶–≤–µ—Ç –Ω–∏–∫–∞ –∏–∑–º–µ–Ω—ë–Ω!','green');
}
function closeCP(e){if(e&&e.target!==document.getElementById('cpmo'))return;document.getElementById('cpmo').classList.remove('show');}

/* ‚îÄ‚îÄ‚îÄ CASES ‚îÄ‚îÄ‚îÄ */
function rCases(){
  document.getElementById('shop-cases').innerHTML=CASES.map(c=>`
    <div class="gc ccard" onclick="openCase(${c.id})">
      <div class="ccimg" style="background:${c.bg}">
        <div class="ccimg-ico" style="background:${c.iconBg};border:1px solid ${c.iconColor}30">${c.icon}</div>
      </div>
      <div class="ccinfo">
        <div class="ccname">${c.name}</div>
        <div class="ccprice"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>${c.price}</div>
        <button class="ccpreview" onclick="event.stopPropagation();showPrizes(${c.id})">üëÅ –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏–∑—ã</button>
      </div>
    </div>`).join('');
}

function showPrizes(id){
  const c=CASES.find(x=>x.id===id);if(!c)return;
  document.getElementById('pv-t').textContent=`üì¶ ${c.name} ‚Äî –ø—Ä–∏–∑—ã`;
  document.getElementById('pv-grid').innerHTML=c.drops.map(d=>`
    <div class="pvitem">
      <div class="pvico">${d.i}</div>
      <div class="pvname">${d.n}</div>
      <div class="pvval">${d.v}</div>
    </div>`).join('');
  document.getElementById('pvmo').classList.add('show');
}
function closePV(e){if(e&&e.target!==document.getElementById('pvmo'))return;document.getElementById('pvmo').classList.remove('show');}

/* ‚îÄ‚îÄ‚îÄ CASE ROULETTE ‚îÄ‚îÄ‚îÄ */
let curC=null,spinning=false;
const IW=94;
function openCase(id){
  curC=CASES.find(c=>c.id===id);if(!curC)return;
  spinning=false;
  document.getElementById('cm-t').textContent=curC.name;
  document.getElementById('cm-cost').textContent=`–°—Ç–æ–∏–º–æ—Å—Ç—å: ${curC.price} ü™ô`;
  const btn=document.getElementById('cm-btn');
  if(S.balance<curC.price){btn.disabled=true;btn.textContent=`–ù—É–∂–Ω–æ ${curC.price} ü™ô`;}
  else{btn.disabled=false;btn.textContent='üé∞ –û—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å';}
  document.getElementById('cm-spin').style.display='block';
  document.getElementById('cres').classList.remove('show');
  buildReel();
  document.getElementById('cmo').classList.add('show');
}
function buildReel(){
  const track=document.getElementById('rtrack');
  let items=[];for(let i=0;i<10;i++)items.push(...curC.drops);
  track.innerHTML=items.map((d,idx)=>`<div class="ritem" id="ri${idx}"><div class="rico">${d.i}</div><div class="rname">${d.n}</div><div class="rval">${d.v}</div></div>`).join('');
  track.style.transition='none';track.style.transform='translateX(0)';
}
function spinCase(){
  if(spinning)return;
  if(S.balance<curC.price){showToast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!','red');return;}
  spinning=true;S.balance-=curC.price;syncB();
  const track=document.getElementById('rtrack');
  const total=curC.drops.length*10;
  const winIdx=Math.floor(total/2)+Math.floor(Math.random()*curC.drops.length);
  const cw=track.parentElement.clientWidth;
  const targetX=-(winIdx*IW-cw/2+IW/2);
  track.style.transition='none';track.style.transform='translateX(4px)';
  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    track.style.transition='transform 5s cubic-bezier(0.1,0.82,0.05,1)';
    track.style.transform=`translateX(${targetX}px)`;
  }));
  setTimeout(()=>{
    document.querySelectorAll('.ritem').forEach(el=>el.classList.remove('win'));
    document.getElementById('ri'+winIdx)?.classList.add('win');
    const winner=curC.drops[winIdx%curC.drops.length];
    setTimeout(()=>{showResult(winner);spinning=false;},700);
  },5000);
}
function showResult(d){
  document.getElementById('cm-spin').style.display='none';
  const r=document.getElementById('cres');r.classList.add('show');
  document.getElementById('cr-ico').textContent=d.i;
  document.getElementById('cr-t').textContent='–í—ã –ø–æ–ª—É—á–∏–ª–∏: '+d.n;
  document.getElementById('cr-s').textContent=d.v;
  if(d.n==='–ú–æ–Ω–µ—Ç—ã'){const n=parseInt(d.v.replace(/\D/g,''))||0;S.balance+=n;syncB();}
  if(d.vipDays){activateVip(d.vipDays);showToast(`üèÜ VIP –Ω–∞ ${d.vipDays} –¥–Ω. –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!`,'green');}
  showToast('üéâ '+d.n+' '+d.v+'!','green');
  if(!S.doneTasks.has(6)){completeTask(6);}
  rShopItems();
}
function closeCase(){document.getElementById('cmo').classList.remove('show');rShopItems();rCases();}

/* ‚îÄ‚îÄ‚îÄ FRIENDS ‚îÄ‚îÄ‚îÄ */
function rRefStats(){
  document.getElementById('ref-count1').textContent=S.refs.length;
  document.getElementById('ref-count2').textContent=0;
  document.getElementById('ref-earned').innerHTML=`<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>${S.refEarned.toLocaleString('ru')}`;
  const cnt=Math.min(S.refs.length,3);
  document.getElementById('ref-prog-bar').style.width=(cnt/3*100)+'%';
  document.getElementById('ref-prog-txt').textContent=cnt+' / 3';
  document.getElementById('p-refs').textContent=S.refs.length;
}
function rRefList(){
  const el=document.getElementById('ref-list');if(!el)return;
  if(!S.refs.length){
    el.innerHTML=`<div class="norefs"><div class="nrico">üë•</div><div class="nrt">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</div><div class="nrs">–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—Å—ã–ª–∫–æ–π —Å –¥—Ä—É–∑—å—è–º–∏</div></div>`;
    return;
  }
  el.innerHTML=S.refs.map(r=>`
    <div class="gc" style="padding:11px 14px;margin-bottom:8px;display:flex;align-items:center;gap:12px">
      <div style="width:36px;height:36px;border-radius:50%;background:var(--gdim);border:1px solid var(--gbor);display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0">üë§</div>
      <div style="flex:1"><div style="font-size:13px;font-weight:600">${r.name}</div><div style="font-size:11px;color:var(--muted2)">${r.date}</div></div>
      <div style="color:var(--green);font-size:12px;font-weight:700">+1000 ü™ô</div>
    </div>`).join('');
}
function copyRef(){const t=document.getElementById('ref-link').textContent;navigator.clipboard?.writeText(t).catch(()=>{});showToast('üìã –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!','green');}
function shareRef(){
  const t=document.getElementById('ref-link').textContent;
  const msg=encodeURIComponent('üéÅ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ SAT Bot –∏ –ø–æ–ª—É—á–∏ 1000 –º–æ–Ω–µ—Ç!\n–ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π, –≤—ã–ø–æ–ª–Ω—è—è –∑–∞–¥–∞–Ω–∏—è –∏ —É—á–∞—Å—Ç–≤—É–π –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–∞—Ö!');
  if(tg){tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(t)}&text=${msg}`);}
  else{copyRef();}
}

/* ‚îÄ‚îÄ‚îÄ PROMO ‚îÄ‚îÄ‚îÄ */
function usePromo(inputId){
  const el=document.getElementById(inputId);
  const code=(el.value||'').trim().toUpperCase();
  if(!code){showToast('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥','red');return;}
  if(S.usedPromos.has(code)){showToast('‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω','red');el.value='';return;}
  const promo=PROMOS[code];
  if(!promo){showToast('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥','red');return;}
  S.usedPromos.add(code);S.balance+=promo.reward;el.value='';
  syncB();rShopItems();showToast(`‚úÖ +${promo.reward} –º–æ–Ω–µ—Ç!`,'green');
}

/* ‚îÄ‚îÄ‚îÄ BOTTOM SHEET ‚îÄ‚îÄ‚îÄ */
let _scb=null;
function openSheet(title,sub,label,cb){
  document.getElementById('sh-t').textContent=title;
  document.getElementById('sh-s').textContent=sub;
  document.getElementById('sh-extra').innerHTML='';
  document.getElementById('sh-a').textContent=label;
  document.getElementById('sh-c').textContent='–û—Ç–º–µ–Ω–∞';
  document.getElementById('sh-c').onclick=closeSheet;
  _scb=cb;
  document.getElementById('sheet').classList.add('show');
}
function closeSheet(e){if(e&&e.target!==document.getElementById('sheet'))return;document.getElementById('sheet').classList.remove('show');_scb=null;}
function doSheet(){if(_scb)_scb();}

/* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
let _tt;
function showToast(msg,type='green'){
  const el=document.getElementById('toast');
  el.textContent=msg;
  el.className='toast '+type;
  el.classList.add('show');
  clearTimeout(_tt);
  _tt=setTimeout(()=>el.classList.remove('show'),2600);
}

init();
</script>
</body>
</html>